From:	noreply@elca.ch
Sent:	Friday, May 13, 2016 15:52
To:	prj_Secutix2Ei
Subject:	secutix2-ei: svn commit (dpp) [1842] STX-65825:  change the way in adding an interface log line with a too big message

Follow Up Flag:	Follow up
Flag Status:	Flagged

Categories:	Interface / Batch, @QHR, @DLP

Revision
1843 <https://svn.elca.ch/viewvc/secutix2-ei?rev=1842>
Author
dpp
Date
2016-05-13 10:52:05 +0200 (Fri, 13 May 2016)


Log Message

STX-65825 <https://jira.secutix.com/browse/STX-65825> : change the way in adding an interface log line with a too big message

Modified Paths


*	trunk/app/tnei/service/src/main/java/com/secutix/process/externalinterface/dataarchive/InterfaceLogLineServiceImpl.java <>


Diff


Modified: trunk/app/tnei/service/src/main/java/com/secutix/process/externalinterface/dataarchive/InterfaceLogLineServiceImpl.java (1841 => 1842)



--- trunk/app/tnei/service/src/main/java/com/secutix/process/externalinterface/dataarchive/InterfaceLogLineServiceImpl.java	2016-05-11 12:27:34 UTC (rev 1841)

+++ trunk/app/tnei/service/src/main/java/com/secutix/process/externalinterface/dataarchive/InterfaceLogLineServiceImpl.java	2016-05-13 08:52:05 UTC (rev 1842)

@@ -35,6 +35,7 @@

 import com.secutix.util.helper.DaoHelper;



 public class InterfaceLogLineServiceImpl implements InterfaceLogLineService, InitializingBean {

+	protected static final int BIG_MESSAGE_LENGTH = 3000;

 	private DaoHelper daoHelper;

 	private static final Log LOGGER = LogFactory.getLog(InterfaceLogLineServiceImpl.class);

 	private static final int NB_MINUTES = 15;

@@ -93,7 +94,13 @@



 			if (InterfaceExecutionHolderThreadLocal.checkExecutionForInstitution(

 					contextProvider.getCurrentInstitutionCode(), execution)) {

-				logLineIds.addAll(getInterfaceLogLineDao().logMessage(execution, severityType, message));

+				// change the way in adding an interface log line with a too big message

+				if (StringUtils.isNotEmpty(message) && message.length() > BIG_MESSAGE_LENGTH) {

+					logLineIds.addAll(getInterfaceLogLineDao().logMessage(execution, severityType,

+							message.substring(0, BIG_MESSAGE_LENGTH) + "..."));

+				} else {

+					logLineIds.addAll(getInterfaceLogLineDao().logMessage(execution, severityType, message));

+				}

 			} else {

 				LOGGER.error("Trying to log a message on an execution in the wrong institution !!! " + execution);

 			}


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Friday, May 13, 2016 14:55
To:	prj_Secutix2Ai
Subject:	secutix2-ai: svn commit (dpp) [1705] Merge revision(s) 1704 from trunk:

Categories:	@QHR, @DLP

Revision
1706 <https://svn.elca.ch/viewvc/secutix2-ai?rev=1705>
Author
dpp
Date
2016-05-13 09:54:50 +0200 (Fri, 13 May 2016)


Log Message

Merge revision(s) 1704 from trunk:

STX-65825 <https://jira.secutix.com/browse/STX-65825> : change the way in adding an interface log line with a too big message

........

Modified Paths


*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties <>


Diff


Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java (1704 => 1705)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:54:50 UTC (rev 1705)

@@ -319,16 +319,15 @@

 			ProcessingResultEnum res = ProcessingResultEnum.valueFromCode(globalResult);

 			List<String> translatedMessages = translateMessages(results.getMessages());

 			if (res == ProcessingResultEnum.FAILURE) {

-				// STX-65825: change the way in adding an interface log line with a too big message

-				logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.error", "message.export.retrievepayments.bigmessage.error",

-						globalResult, StringUtils.join(translatedMessages, ", "));

+

+				interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.error", globalResult,

+						StringUtils.join(translatedMessages, ", "));

 				return Tuple2.of(allPaymentsRetrieved, Optional.of(InterfaceExecutionStateEnum.KO));

 			} else if (res == ProcessingResultEnum.WARNING) {

-				// STX-65825: change the way in adding an interface log line with a too big message

-				logLineWithBigMessage(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.warning", "message.export.retrievepayments.bigmessage.warning",

-						globalResult, StringUtils.join(translatedMessages, ", "));

+				interfaceLogLineService.logMessageML(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.warning", globalResult,

+						StringUtils.join(translatedMessages, ", "));

 			}



 			@SuppressWarnings("unchecked")



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java (1704 => 1705)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java	2016-05-13 07:54:50 UTC (rev 1705)

@@ -3,7 +3,6 @@

 import static com.google.common.collect.FluentIterable.from;



 import java.math.BigDecimal;

-import java.util.Arrays;

 import java.util.Collection;

 import java.util.Collections;

 import java.util.Date;

@@ -43,7 +42,6 @@

 import com.secutix.model.externalInterface.ExternalInterfaceHelper;

 import com.secutix.model.externalInterface.InterfaceExecution;

 import com.secutix.model.externalInterface.InterfaceExecutionSchedule;

-import com.secutix.model.externalInterface.InterfaceLogLine;

 import com.secutix.model.externalInterface.InterfaceLogLine.SeverityType;

 import com.secutix.model.institution.PaymentMethod;

 import com.secutix.model.organization.Organization;

@@ -70,7 +68,6 @@

 	protected static final String SAP_BT_IN_CONFIRMED_PM_IDCODE = "SAPREFC";

 	protected static final String CREDIT_NOTE_NO_AUTOREFUND_PM_IDCODE = "CRNOAURE";

 	protected static final String REFUND_IN_PROGRESS_PM_IDCODE = "REFUND_IN_PROGRESS";

-	protected static final int BIG_MESSAGE_LENGTH = 3000;



 	@SuppressWarnings("serial")

 	protected static final Map<String, String> defaultMappings = new HashMap<String, String>() {

@@ -347,35 +344,4 @@

 			return Optional.<Long> absent();

 		}

 	}

-

-	// STX-65825: change the way in adding an interface log line with a too big message

-	protected void logLineWithBigMessage(SeverityType severityType, LogLineTitleCode titleCode, String messageKey,

-			String bigmessageKey, Object param1, String message) {

-		if (StringUtils.isEmpty(message) || message.length() <= BIG_MESSAGE_LENGTH) {

-			interfaceLogLineService.logMessageML(severityType, titleCode, messageKey, param1, message);

-		} else {

-			interfaceLogLineService.logMessageML(severityType, titleCode, bigmessageKey, param1,

-					message.substring(0, BIG_MESSAGE_LENGTH));

-		}

-	}

-

-	protected void logLineWithBigMessage(SeverityType severityType, LogLineTitleCode titleCode, String messageKey,

-			String bigmessageKey, Object param1, Object param2, String message) {

-		if (StringUtils.isEmpty(message) || message.length() <= BIG_MESSAGE_LENGTH) {

-			interfaceLogLineService.logMessageML(severityType, titleCode, messageKey, param1, param2, message);

-		} else {

-			interfaceLogLineService.logMessageML(severityType, titleCode, bigmessageKey, param1, param2,

-					message.substring(0, BIG_MESSAGE_LENGTH));

-		}

-	}

-

-	protected void logLineWithBigMessage(SeverityType severityType, LogLineTitleCode titleCode, String messageKey,

-			String bigmessageKey, Object param1, Object param2, Object param3, String message) {

-		if (StringUtils.isEmpty(message) || message.length() <= BIG_MESSAGE_LENGTH) {

-			interfaceLogLineService.logMessageML(severityType, titleCode, messageKey, param1, param2, param3, message);

-		} else {

-			interfaceLogLineService.logMessageML(severityType, titleCode, bigmessageKey, param1, param2, param3,

-					message.substring(0, BIG_MESSAGE_LENGTH));

-		}

-	}

 }



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java (1704 => 1705)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java	2016-05-13 07:54:50 UTC (rev 1705)

@@ -602,34 +602,32 @@

 					sapDocumentNumber);

 			break;

 		case FAILURE:

-			// STX-65825: change the way in adding an interface log line with a too big message

-			logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-					"message.export.invoices.error",

-					"message.export.invoices.bigmessage.error",

-					globalResult,

+

+			interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+					"message.export.invoices.error", globalResult,

 					invoiceToString(exportedInvoice.getInvoiceId().longValue(), exportedInvoice.getInvoiceNumber()),

 					StringUtils.join(translatedMessage, ", "));

 			break;

 		case WARNING:

 			if (invoiceAlreadyExists(StringUtils.join(translatedMessage, ", "))) {

-				// STX-65825: change the way in adding an interface log line with a too big message

-				logLineWithBigMessage(

+				interfaceLogLineService

+						.logMessageML(

 								SeverityType.ARCHIVE,

 								null,

 								"message.export.invoices.created.withwarning",

-								"message.export.invoices.created.bigmessage.withwarning",

-								invoiceToString(exportedInvoice.getInvoiceId().longValue(), exportedInvoice.getInvoiceNumber()),

-								sapDocumentNumber, StringUtils.join(translatedMessage, ", "));

+								invoiceToString(exportedInvoice.getInvoiceId().longValue(),

+										exportedInvoice.getInvoiceNumber()), sapDocumentNumber,

+								StringUtils.join(translatedMessage, ", "));

 				res = ProcessingResultEnum.ALREADY_PROCESSED;

 			} else {

-				// STX-65825: change the way in adding an interface log line with a too big message

-				logLineWithBigMessage(

+				interfaceLogLineService

+						.logMessageML(

 								SeverityType.WARNING,

 								null,

 								"message.export.invoices.created.withwarning",

-								"message.export.invoices.created.bigmessage.withwarning",

-								invoiceToString(exportedInvoice.getInvoiceId().longValue(), exportedInvoice.getInvoiceNumber()),

-								sapDocumentNumber, StringUtils.join(translatedMessage, ", "));

+								invoiceToString(exportedInvoice.getInvoiceId().longValue(),

+										exportedInvoice.getInvoiceNumber()), sapDocumentNumber,

+								StringUtils.join(translatedMessage, ", "));

 			}



 			break;



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java (1704 => 1705)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:54:50 UTC (rev 1705)

@@ -406,17 +406,17 @@

 					paymentExportData.getPaymentId(), sapDocumentNumber);

 			break;

 		case FAILURE:

-			// STX-65825: change the way in adding an interface log line with a too big message

-			logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-					"message.export.payments.error", "message.export.payments.bigmessage.error",

-					globalResult, paymentExportData.getPaymentId(), StringUtils.join(translatedMessage, ", "));

+

+			interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+					"message.export.payments.error", globalResult, paymentExportData.getPaymentId(),

+					StringUtils.join(translatedMessage, ", "));

 			break;

 		case WARNING:

-			// STX-65825: change the way in adding an interface log line with a too big message

-			logLineWithBigMessage(SeverityType.ARCHIVE, null,

-					"message.export.payments.created.withwarning", "message.export.payments.created.bigmessage.withwarning",

-					paymentExportData.getPaymentId(), sapDocumentNumber, StringUtils.join(translatedMessage, ", "));



+			interfaceLogLineService.logMessageML(SeverityType.ARCHIVE, null,

+					"message.export.payments.created.withwarning", paymentExportData.getPaymentId(), sapDocumentNumber,

+					StringUtils.join(translatedMessage, ", "));

+

 			break;

 		default:

 			throw new ServiceBaseRTException("Unknown value :" + res);



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java (1704 => 1705)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java	2016-05-13 07:54:50 UTC (rev 1705)

@@ -449,26 +449,23 @@

 		case FAILURE:

 			requestRefundResult.getInvoiceIdsKO().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberKO().add(requestRefundInvoiceData.getInvoiceNumber());

-			// STX-65825: change the way in adding an interface log line with a too big message

-			logLineWithBigMessage(

+

+			interfaceLogLineService.logMessageML(

 					SeverityType.ERROR,

 					LogLineTitleCode.EXTERNAL,

 					"message.sapRequestRefund.request.failure",

-					"message.sapRequestRefund.bigmessage.request.failure",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

-							requestRefundInvoiceData.getInvoiceNumber()),

-					StringUtils.join(translateMessages, ", "));

+							requestRefundInvoiceData.getInvoiceNumber()), StringUtils.join(translateMessages, ", "));

 			break;

 		case WARNING:

 			requestRefundResult.getInvoiceIdsWarning().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberWarning().add(requestRefundInvoiceData.getInvoiceNumber());



-			logLineWithBigMessage(

+			interfaceLogLineService.logMessageML(

 					SeverityType.WARNING,

 					null,

 					"message.sapRequestRefund.request.warning",

-					"message.sapRequestRefund.bigmessage.request.warning",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

 							requestRefundInvoiceData.getInvoiceNumber()), sapDocumentNumber,

@@ -478,11 +475,10 @@

 			requestRefundResult.getInvoiceIdsAlreadyProcessed().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberAlreadyProcessed().add(requestRefundInvoiceData.getInvoiceNumber());



-			logLineWithBigMessage(

+			interfaceLogLineService.logMessageML(

 					SeverityType.WARNING,

 					null,

 					"message.sapRequestRefund.request.alreadyProcessed",

-					"message.sapRequestRefund.bigmessage.request.alreadyProcessed",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

 							requestRefundInvoiceData.getInvoiceNumber()), sapDocumentNumber,

@@ -492,11 +488,10 @@

 			requestRefundResult.getInvoiceIdsIgnored().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberIgnored().add(requestRefundInvoiceData.getInvoiceNumber());



-			logLineWithBigMessage(

+			interfaceLogLineService.logMessageML(

 					SeverityType.WARNING,

 					null,

 					"message.sapRequestRefund.request.ignored",

-					"message.sapRequestRefund.bigmessage.request.ignored",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

 							requestRefundInvoiceData.getInvoiceNumber()), sapDocumentNumber,



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java (1704 => 1705)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:54:50 UTC (rev 1705)

@@ -334,16 +334,15 @@

 			ProcessingResultEnum res = ProcessingResultEnum.valueFromCode(globalResult);

 			List<String> translatedMessages = translateMessages(results.getMessages());

 			if (res == ProcessingResultEnum.FAILURE) {

-				// STX-65825: change the way in adding an interface log line with a too big message

-				logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.error", "message.export.retrievepayments.bigmessage.error",

-						globalResult, StringUtils.join(translatedMessages, ", "));

+

+				interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.error", globalResult,

+						StringUtils.join(translatedMessages, ", "));

 				return Tuple2.of(allPaymentsRetrieved, Optional.of(InterfaceExecutionStateEnum.KO));

 			} else if (res == ProcessingResultEnum.WARNING) {

-				// STX-65825: change the way in adding an interface log line with a too big message

-				logLineWithBigMessage(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.warning", "message.export.retrievepayments.bigmessage.warning",

-						globalResult, StringUtils.join(translatedMessages, ", "));

+				interfaceLogLineService.logMessageML(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.warning", globalResult,

+						StringUtils.join(translatedMessages, ", "));

 			}



 			List<ZpitchClearedPayment> paymentsToProcess = results.getClearedPayments().getItem();



Modified: trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties (1704 => 1705)



--- trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties	2016-05-13 07:06:01 UTC (rev 1704)

+++ trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties	2016-05-13 07:54:50 UTC (rev 1705)

@@ -38,9 +38,7 @@

 message.export.invoices.count=Invoices to export count : {0}

 message.export.invoices.created=Exported invoice : {0} - {1}

 message.export.invoices.created.withwarning=Exported invoice : {0} - {1} : {2}

-message.export.invoices.created.bigmessage.withwarning=Exported invoice : {0} - {1} : {2}... There are too big invoice messages so please go to the archive invoice file to see full messages.

 message.export.invoices.error=Error {0} while exporting invoice {1} : {2}

-message.export.invoices.bigmessage.error=Error {0} while exporting invoice {1} : {2}... There are too big invoice messages so please go to the archive invoice file to see full messages.

 message.export.invoices.ignored.creativeandnegative=Invoice {0} ignored. It contains both positive and negative amounts.

 message.export.invoices.ignored.nullamount=Invoice {0} ignored. No amount.

 message.export.invoices.ignored.nooperation=Invoice {0} ignored. No operations are linked.

@@ -59,16 +57,12 @@

 message.export.payments.noInvoice=Payment {0} is associated to no invoices : {1}. It'll be ignored.

 message.export.payments.created=Payment created : {0} - {1}

 message.export.payments.created.withwarning=Payment created : {0} - {1} : {2}

-message.export.payments.created.bigmessage.withwarning=Payment created : {0} - {1} : {2}...There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.payments.error=Error {0} while exporting payment {1} : {2}

-message.export.payments.bigmessage.error=Error {0} while exporting payment {1} : {2}... There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.payments.exported={0} payments exported OK, {1} ignored, {2} with warning, {3} not exported because of failures.



 message.export.retrievepayments.from=Retrieving payments from: {0}

 message.export.retrievepayments.error=Error while retrieving payments : {0} - {1}

-message.export.retrievepayments.bigmessage.error=Error while retrieving payments : {0} - {1}... There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.retrievepayments.warning=Warning while retrieving payments : {0} - {1}

-message.export.retrievepayments.bigmessage.warning=Warning while retrieving payments : {0} - {1}... There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.retrievepayments.nbResults={0} payments retrieved.

 message.export.retrievepayments.toprocess={0} payments to process.

 message.export.retrievepayments.process.error=Error while processing payment : {0} for invoice {1} and contact {2} - {3}

@@ -159,13 +153,9 @@

 message.sapRequestRefund.invoicesErrorDuringInternalRefund={0} invoice(s) error during SecuTix refund payment creation : {0}

 message.sapRequestRefund.request.success=Request refund success, refundId {0}, invoice {1}, document {2}

 message.sapRequestRefund.request.failure=Request refund failed, refundId {0}, invoice {1}, messages : {2}

-message.sapRequestRefund.bigmessage.request.failure=Request refund failed, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.request.warning=Request refund warned, refundId {0}, invoice {1}, messages : {2}

-message.sapRequestRefund.bigmessage.request.warning=Request refund warned, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.request.alreadyProcessed=Request refund already processed, refundId {0}, invoice {1}, messages : {2}

-message.sapRequestRefund.bigmessage.request.alreadyProcessed=Request refund already processed, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.request.ignored=Request refund ingored, refundId {0}, invoice {1}, messages : {2}

-message.sapRequestRefund.bigmessage.request.ignored=Request refund ingored, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.internalPaymentCreationError=Error during SecuTix refund payment creation with {0} : {1}.



 message.export.retrievepayments.process.wrongCurrency=Payment: {0} linked to invoice: {1} was sent with a currency: {2} not matching the organization currency: {3}


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Friday, May 13, 2016 14:15
To:	prj_Secutix2Vi
Subject:	secutix2-vi: svn commit (mnv) [1577] STX-65750: for new organization,  if database is missing external interface when validation visit,  automatic create external interface before validation visit

Categories:	@QHR, @DLP

Revision
1577 <https://svn.elca.ch/viewvc/secutix2-vi?rev=1577>
Author
mnv
Date
2016-05-13 09:14:54 +0200 (Fri, 13 May 2016)


Log Message

STX-65750 <https://jira.secutix.com/browse/STX-65750> : for new organization, if database is missing external interface when validation visit, automatic create external interface before validation visit

Modified Paths


*	trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/catalog/ValidationVisitEventController.java <>


Diff


Modified: trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/catalog/ValidationVisitEventController.java (1576 => 1577)



--- trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/catalog/ValidationVisitEventController.java	2016-05-12 22:04:57 UTC (rev 1576)

+++ trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/catalog/ValidationVisitEventController.java	2016-05-13 07:14:54 UTC (rev 1577)

@@ -20,6 +20,7 @@



 import com.google.common.collect.Maps;



+import com.secutix.facade.OrganizationContextProviderFactory;

 import com.secutix.model.InternalCode;

 import com.secutix.model.catalog.Performance;

 import com.secutix.model.externalInterface.ExternalInterface;

@@ -31,6 +32,7 @@

 import com.secutix.model.externalInterface.InterfaceFunction;

 import com.secutix.model.externalInterface.InterfaceType;

 import com.secutix.model.type.DateTime;

+import com.secutix.model.type.MLInternalName;

 import com.secutix.model.type.TimeSpan;

 import com.secutix.model.validation.Validation;

 import com.secutix.service.OrganizationContextProvider;

@@ -73,6 +75,7 @@

 	private static final String LOCALE_IC = PREFIX + "LOCALE";

 	private static final TimeSpan TEN_MINUTE_TIME_SPAN = new TimeSpan(0, 10, 0);

 	private static final TimeSpan OBSOLETE_VALIDATION_TIME = TEN_MINUTE_TIME_SPAN;

+	private static final String INTERFACE_FUNCTION_CODE = "Vivafu";



 	@Autowired

 	private SchedulerNotificationService schedulerNotificationService;

@@ -122,7 +125,7 @@

 	 * @return

 	 */

 	private String buildValidationBatchLink(Validation entity, Locale locale) {

-		ExternalInterface externalInterface = getExternalInterfaces();

+		ExternalInterface externalInterface = getOrCreateExternalInterfaces();

 		StringBuilder returnValue = new StringBuilder("");

 		if (externalInterface != null) {

 			String currentInstitutionCode = getContextProvider().getCurrentInstitutionCode();

@@ -186,7 +189,7 @@

 			Locale locale) {

 		List<String> messages = new ArrayList<String>();

 		if (ACTION_VALIDATE.equals(action)) {

-			ExternalInterface exInterface = getExternalInterfaces();

+			ExternalInterface exInterface = getOrCreateExternalInterfaces();

 			InterfaceFunction interfaceFunction = getInterfaceFunction();

 			if (interfaceFunction != null && exInterface != null) {

 				InterfaceExecutionSchedule ie = buildInterfaceExecutionSchedule(exInterface, interfaceFunction);

@@ -305,7 +308,7 @@

 	/**

 	 *

 	 */

-	private ExternalInterface getExternalInterfaces() {

+	private ExternalInterface getOrCreateExternalInterfaces() {



 		DetachedCriteria subDc = StxDetachedCriteria.forClassWithInstitution(InterfaceType.class,

 				getContextProvider().getCurrentInstitutionCode(), "itype");

@@ -318,16 +321,44 @@

 				((OrganizationContextProvider) getContextProvider()).getCurrentOrganizationId()));

 		dc.add(Subqueries.propertyIn("exint.interfaceTypeId", subDc));

 		List<ExternalInterface> exInterfaces = getDaoHelper().getDao(ExternalInterface.class)

-				.findByCriteria(dc, -1, -1);

+				.findByNavigationQuery(dc, 0, 1);

 		if (exInterfaces != null && !exInterfaces.isEmpty()) {

 			return exInterfaces.get(0);

 		} else {

-			return null;

+			// STX-65750: External interfaces was missing in database,

+			// need to create it if database already have interface function "Vivafu"

+			return createExternalInterfaces();

 		}



 	}

+

+	private ExternalInterface createExternalInterfaces() {

+		InterfaceType interfaceType = getInterfaceType();

+		if (interfaceType != null) {

+			// Create the external interface

+			final ExternalInterface externalInterface = new ExternalInterface();

+			externalInterface.setInstitutionCode(OrganizationContextProviderFactory

+					.getOrganizationContextProvider().getCurrentInstitutionCode());

+			externalInterface.setActive(true);

+			externalInterface.setOrganization(OrganizationContextProviderFactory.getOrganizationContextProvider()

+					.getCurrentOrganization());

+			externalInterface.setInternalName(new MLInternalName(new String[] { "Default visit validation batch" }));

+			externalInterface.setInterfaceType(interfaceType);

+			return getDaoHelper().getDao(ExternalInterface.class).saveOrUpdate(externalInterface);

+		}

+		return null;

+	}

+

+	private InterfaceType getInterfaceType() {

+		DetachedCriteria dc = getDaoHelper().getCriteriaWithInstitution(InterfaceFunction.class);

+		dc.add(Restrictions.eq("code", INTERFACE_FUNCTION_CODE));

+		List<InterfaceFunction> interfaceFunction = getDaoHelper().getDao(InterfaceFunction.class).findByNavigationQuery(dc, 0, 1);

+		if (!CollectionHelper.isEmpty(interfaceFunction)) {

+			return interfaceFunction.get(0).getInterfaceType();

+		}

+		return null;

+	}



-

 	public SchedulerNotificationService getSchedulerNotificationService() {

 		return schedulerNotificationService;

 	}


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Friday, May 13, 2016 14:06
To:	prj_Secutix2Ai
Subject:	secutix2-ai: svn commit (dpp) [1704] STX-65825:  change the way in adding an interface log line with a too big message

Categories:	@QHR, @DLP

Revision
1704 <https://svn.elca.ch/viewvc/secutix2-ai?rev=1704>
Author
dpp
Date
2016-05-13 09:06:01 +0200 (Fri, 13 May 2016)


Log Message

STX-65825 <https://jira.secutix.com/browse/STX-65825> : change the way in adding an interface log line with a too big message

Modified Paths


*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java <>
*	trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties <>


Diff


Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java (1703 => 1704)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractRetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

@@ -319,15 +319,16 @@

 			ProcessingResultEnum res = ProcessingResultEnum.valueFromCode(globalResult);

 			List<String> translatedMessages = translateMessages(results.getMessages());

 			if (res == ProcessingResultEnum.FAILURE) {

-

-				interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.error", globalResult,

-						StringUtils.join(translatedMessages, ", "));

+				// STX-65825: change the way in adding an interface log line with a too big message

+				logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.error", "message.export.retrievepayments.bigmessage.error",

+						globalResult, StringUtils.join(translatedMessages, ", "));

 				return Tuple2.of(allPaymentsRetrieved, Optional.of(InterfaceExecutionStateEnum.KO));

 			} else if (res == ProcessingResultEnum.WARNING) {

-				interfaceLogLineService.logMessageML(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.warning", globalResult,

-						StringUtils.join(translatedMessages, ", "));

+				// STX-65825: change the way in adding an interface log line with a too big message

+				logLineWithBigMessage(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.warning", "message.export.retrievepayments.bigmessage.warning",

+						globalResult, StringUtils.join(translatedMessages, ", "));

 			}



 			@SuppressWarnings("unchecked")



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java (1703 => 1704)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/AbstractSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

@@ -3,6 +3,7 @@

 import static com.google.common.collect.FluentIterable.from;



 import java.math.BigDecimal;

+import java.util.Arrays;

 import java.util.Collection;

 import java.util.Collections;

 import java.util.Date;

@@ -42,6 +43,7 @@

 import com.secutix.model.externalInterface.ExternalInterfaceHelper;

 import com.secutix.model.externalInterface.InterfaceExecution;

 import com.secutix.model.externalInterface.InterfaceExecutionSchedule;

+import com.secutix.model.externalInterface.InterfaceLogLine;

 import com.secutix.model.externalInterface.InterfaceLogLine.SeverityType;

 import com.secutix.model.institution.PaymentMethod;

 import com.secutix.model.organization.Organization;

@@ -68,6 +70,7 @@

 	protected static final String SAP_BT_IN_CONFIRMED_PM_IDCODE = "SAPREFC";

 	protected static final String CREDIT_NOTE_NO_AUTOREFUND_PM_IDCODE = "CRNOAURE";

 	protected static final String REFUND_IN_PROGRESS_PM_IDCODE = "REFUND_IN_PROGRESS";

+	protected static final int BIG_MESSAGE_LENGTH = 3000;



 	@SuppressWarnings("serial")

 	protected static final Map<String, String> defaultMappings = new HashMap<String, String>() {

@@ -344,4 +347,35 @@

 			return Optional.<Long> absent();

 		}

 	}

+

+	// STX-65825: change the way in adding an interface log line with a too big message

+	protected void logLineWithBigMessage(SeverityType severityType, LogLineTitleCode titleCode, String messageKey,

+			String bigmessageKey, Object param1, String message) {

+		if (StringUtils.isEmpty(message) || message.length() <= BIG_MESSAGE_LENGTH) {

+			interfaceLogLineService.logMessageML(severityType, titleCode, messageKey, param1, message);

+		} else {

+			interfaceLogLineService.logMessageML(severityType, titleCode, bigmessageKey, param1,

+					message.substring(0, BIG_MESSAGE_LENGTH));

+		}

+	}

+

+	protected void logLineWithBigMessage(SeverityType severityType, LogLineTitleCode titleCode, String messageKey,

+			String bigmessageKey, Object param1, Object param2, String message) {

+		if (StringUtils.isEmpty(message) || message.length() <= BIG_MESSAGE_LENGTH) {

+			interfaceLogLineService.logMessageML(severityType, titleCode, messageKey, param1, param2, message);

+		} else {

+			interfaceLogLineService.logMessageML(severityType, titleCode, bigmessageKey, param1, param2,

+					message.substring(0, BIG_MESSAGE_LENGTH));

+		}

+	}

+

+	protected void logLineWithBigMessage(SeverityType severityType, LogLineTitleCode titleCode, String messageKey,

+			String bigmessageKey, Object param1, Object param2, Object param3, String message) {

+		if (StringUtils.isEmpty(message) || message.length() <= BIG_MESSAGE_LENGTH) {

+			interfaceLogLineService.logMessageML(severityType, titleCode, messageKey, param1, param2, param3, message);

+		} else {

+			interfaceLogLineService.logMessageML(severityType, titleCode, bigmessageKey, param1, param2, param3,

+					message.substring(0, BIG_MESSAGE_LENGTH));

+		}

+	}

 }



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java (1703 => 1704)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportInvoicesSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

@@ -602,32 +602,34 @@

 					sapDocumentNumber);

 			break;

 		case FAILURE:

-

-			interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-					"message.export.invoices.error", globalResult,

+			// STX-65825: change the way in adding an interface log line with a too big message

+			logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+					"message.export.invoices.error",

+					"message.export.invoices.bigmessage.error",

+					globalResult,

 					invoiceToString(exportedInvoice.getInvoiceId().longValue(), exportedInvoice.getInvoiceNumber()),

 					StringUtils.join(translatedMessage, ", "));

 			break;

 		case WARNING:

 			if (invoiceAlreadyExists(StringUtils.join(translatedMessage, ", "))) {

-				interfaceLogLineService

-						.logMessageML(

+				// STX-65825: change the way in adding an interface log line with a too big message

+				logLineWithBigMessage(

 								SeverityType.ARCHIVE,

 								null,

 								"message.export.invoices.created.withwarning",

-								invoiceToString(exportedInvoice.getInvoiceId().longValue(),

-										exportedInvoice.getInvoiceNumber()), sapDocumentNumber,

-								StringUtils.join(translatedMessage, ", "));

+								"message.export.invoices.created.bigmessage.withwarning",

+								invoiceToString(exportedInvoice.getInvoiceId().longValue(), exportedInvoice.getInvoiceNumber()),

+								sapDocumentNumber, StringUtils.join(translatedMessage, ", "));

 				res = ProcessingResultEnum.ALREADY_PROCESSED;

 			} else {

-				interfaceLogLineService

-						.logMessageML(

+				// STX-65825: change the way in adding an interface log line with a too big message

+				logLineWithBigMessage(

 								SeverityType.WARNING,

 								null,

 								"message.export.invoices.created.withwarning",

-								invoiceToString(exportedInvoice.getInvoiceId().longValue(),

-										exportedInvoice.getInvoiceNumber()), sapDocumentNumber,

-								StringUtils.join(translatedMessage, ", "));

+								"message.export.invoices.created.bigmessage.withwarning",

+								invoiceToString(exportedInvoice.getInvoiceId().longValue(), exportedInvoice.getInvoiceNumber()),

+								sapDocumentNumber, StringUtils.join(translatedMessage, ", "));

 			}



 			break;



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java (1703 => 1704)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/ExportPaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

@@ -406,17 +406,17 @@

 					paymentExportData.getPaymentId(), sapDocumentNumber);

 			break;

 		case FAILURE:

-

-			interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-					"message.export.payments.error", globalResult, paymentExportData.getPaymentId(),

-					StringUtils.join(translatedMessage, ", "));

+			// STX-65825: change the way in adding an interface log line with a too big message

+			logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+					"message.export.payments.error", "message.export.payments.bigmessage.error",

+					globalResult, paymentExportData.getPaymentId(), StringUtils.join(translatedMessage, ", "));

 			break;

 		case WARNING:

+			// STX-65825: change the way in adding an interface log line with a too big message

+			logLineWithBigMessage(SeverityType.ARCHIVE, null,

+					"message.export.payments.created.withwarning", "message.export.payments.created.bigmessage.withwarning",

+					paymentExportData.getPaymentId(), sapDocumentNumber, StringUtils.join(translatedMessage, ", "));



-			interfaceLogLineService.logMessageML(SeverityType.ARCHIVE, null,

-					"message.export.payments.created.withwarning", paymentExportData.getPaymentId(), sapDocumentNumber,

-					StringUtils.join(translatedMessage, ", "));

-

 			break;

 		default:

 			throw new ServiceBaseRTException("Unknown value :" + res);



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java (1703 => 1704)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RequestRefundSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

@@ -449,23 +449,26 @@

 		case FAILURE:

 			requestRefundResult.getInvoiceIdsKO().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberKO().add(requestRefundInvoiceData.getInvoiceNumber());

-

-			interfaceLogLineService.logMessageML(

+			// STX-65825: change the way in adding an interface log line with a too big message

+			logLineWithBigMessage(

 					SeverityType.ERROR,

 					LogLineTitleCode.EXTERNAL,

 					"message.sapRequestRefund.request.failure",

+					"message.sapRequestRefund.bigmessage.request.failure",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

-							requestRefundInvoiceData.getInvoiceNumber()), StringUtils.join(translateMessages, ", "));

+							requestRefundInvoiceData.getInvoiceNumber()),

+					StringUtils.join(translateMessages, ", "));

 			break;

 		case WARNING:

 			requestRefundResult.getInvoiceIdsWarning().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberWarning().add(requestRefundInvoiceData.getInvoiceNumber());



-			interfaceLogLineService.logMessageML(

+			logLineWithBigMessage(

 					SeverityType.WARNING,

 					null,

 					"message.sapRequestRefund.request.warning",

+					"message.sapRequestRefund.bigmessage.request.warning",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

 							requestRefundInvoiceData.getInvoiceNumber()), sapDocumentNumber,

@@ -475,10 +478,11 @@

 			requestRefundResult.getInvoiceIdsAlreadyProcessed().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberAlreadyProcessed().add(requestRefundInvoiceData.getInvoiceNumber());



-			interfaceLogLineService.logMessageML(

+			logLineWithBigMessage(

 					SeverityType.WARNING,

 					null,

 					"message.sapRequestRefund.request.alreadyProcessed",

+					"message.sapRequestRefund.bigmessage.request.alreadyProcessed",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

 							requestRefundInvoiceData.getInvoiceNumber()), sapDocumentNumber,

@@ -488,10 +492,11 @@

 			requestRefundResult.getInvoiceIdsIgnored().add(requestRefundInvoiceData.getInvoiceId());

 			requestRefundResult.getInvoicesNumberIgnored().add(requestRefundInvoiceData.getInvoiceNumber());



-			interfaceLogLineService.logMessageML(

+			logLineWithBigMessage(

 					SeverityType.WARNING,

 					null,

 					"message.sapRequestRefund.request.ignored",

+					"message.sapRequestRefund.bigmessage.request.ignored",

 					externalRefundId,

 					invoiceToString(requestRefundInvoiceData.getInvoiceId(),

 							requestRefundInvoiceData.getInvoiceNumber()), sapDocumentNumber,



Modified: trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java (1703 => 1704)



--- trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/adapters/uefa-sap/service/src/main/java/com/secutix/process/accounting/sap/RetrievePaymentsSapAccountingInterfaceAdapter.java	2016-05-13 07:06:01 UTC (rev 1704)

@@ -334,15 +334,16 @@

 			ProcessingResultEnum res = ProcessingResultEnum.valueFromCode(globalResult);

 			List<String> translatedMessages = translateMessages(results.getMessages());

 			if (res == ProcessingResultEnum.FAILURE) {

-

-				interfaceLogLineService.logMessageML(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.error", globalResult,

-						StringUtils.join(translatedMessages, ", "));

+				// STX-65825: change the way in adding an interface log line with a too big message

+				logLineWithBigMessage(SeverityType.ERROR, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.error", "message.export.retrievepayments.bigmessage.error",

+						globalResult, StringUtils.join(translatedMessages, ", "));

 				return Tuple2.of(allPaymentsRetrieved, Optional.of(InterfaceExecutionStateEnum.KO));

 			} else if (res == ProcessingResultEnum.WARNING) {

-				interfaceLogLineService.logMessageML(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

-						"message.export.retrievepayments.warning", globalResult,

-						StringUtils.join(translatedMessages, ", "));

+				// STX-65825: change the way in adding an interface log line with a too big message

+				logLineWithBigMessage(SeverityType.WARNING, LogLineTitleCode.EXTERNAL,

+						"message.export.retrievepayments.warning", "message.export.retrievepayments.bigmessage.warning",

+						globalResult, StringUtils.join(translatedMessages, ", "));

 			}



 			List<ZpitchClearedPayment> paymentsToProcess = results.getClearedPayments().getItem();



Modified: trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties (1703 => 1704)



--- trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties	2016-05-12 13:22:31 UTC (rev 1703)

+++ trunk/app/tnai/web/resources/src/main/webapp/WEB-INF/i18n/message/tnai_messages.properties	2016-05-13 07:06:01 UTC (rev 1704)

@@ -38,7 +38,9 @@

 message.export.invoices.count=Invoices to export count : {0}

 message.export.invoices.created=Exported invoice : {0} - {1}

 message.export.invoices.created.withwarning=Exported invoice : {0} - {1} : {2}

+message.export.invoices.created.bigmessage.withwarning=Exported invoice : {0} - {1} : {2}... There are too big invoice messages so please go to the archive invoice file to see full messages.

 message.export.invoices.error=Error {0} while exporting invoice {1} : {2}

+message.export.invoices.bigmessage.error=Error {0} while exporting invoice {1} : {2}... There are too big invoice messages so please go to the archive invoice file to see full messages.

 message.export.invoices.ignored.creativeandnegative=Invoice {0} ignored. It contains both positive and negative amounts.

 message.export.invoices.ignored.nullamount=Invoice {0} ignored. No amount.

 message.export.invoices.ignored.nooperation=Invoice {0} ignored. No operations are linked.

@@ -57,12 +59,16 @@

 message.export.payments.noInvoice=Payment {0} is associated to no invoices : {1}. It'll be ignored.

 message.export.payments.created=Payment created : {0} - {1}

 message.export.payments.created.withwarning=Payment created : {0} - {1} : {2}

+message.export.payments.created.bigmessage.withwarning=Payment created : {0} - {1} : {2}...There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.payments.error=Error {0} while exporting payment {1} : {2}

+message.export.payments.bigmessage.error=Error {0} while exporting payment {1} : {2}... There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.payments.exported={0} payments exported OK, {1} ignored, {2} with warning, {3} not exported because of failures.



 message.export.retrievepayments.from=Retrieving payments from: {0}

 message.export.retrievepayments.error=Error while retrieving payments : {0} - {1}

+message.export.retrievepayments.bigmessage.error=Error while retrieving payments : {0} - {1}... There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.retrievepayments.warning=Warning while retrieving payments : {0} - {1}

+message.export.retrievepayments.bigmessage.warning=Warning while retrieving payments : {0} - {1}... There are too big payment messages so please go to the archive payment file to see full messages.

 message.export.retrievepayments.nbResults={0} payments retrieved.

 message.export.retrievepayments.toprocess={0} payments to process.

 message.export.retrievepayments.process.error=Error while processing payment : {0} for invoice {1} and contact {2} - {3}

@@ -153,9 +159,13 @@

 message.sapRequestRefund.invoicesErrorDuringInternalRefund={0} invoice(s) error during SecuTix refund payment creation : {0}

 message.sapRequestRefund.request.success=Request refund success, refundId {0}, invoice {1}, document {2}

 message.sapRequestRefund.request.failure=Request refund failed, refundId {0}, invoice {1}, messages : {2}

+message.sapRequestRefund.bigmessage.request.failure=Request refund failed, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.request.warning=Request refund warned, refundId {0}, invoice {1}, messages : {2}

+message.sapRequestRefund.bigmessage.request.warning=Request refund warned, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.request.alreadyProcessed=Request refund already processed, refundId {0}, invoice {1}, messages : {2}

+message.sapRequestRefund.bigmessage.request.alreadyProcessed=Request refund already processed, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.request.ignored=Request refund ingored, refundId {0}, invoice {1}, messages : {2}

+message.sapRequestRefund.bigmessage.request.ignored=Request refund ingored, refundId {0}, invoice {1}, messages : {2}... There are too big refund messages so please go to the archive request refunds file to see full messages.

 message.sapRequestRefund.internalPaymentCreationError=Error during SecuTix refund payment creation with {0} : {1}.



 message.export.retrievepayments.process.wrongCurrency=Payment: {0} linked to invoice: {1} was sent with a currency: {2} not matching the organization currency: {3}


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Friday, May 13, 2016 13:41
To:	prj_secutix2-seb
Subject:	secutix2-seb: svn commit (tnh) [41174]  STX-65603 - remove check advantageLimitException when user login after buying on shop , processPayment step will check it.

Categories:	Sales Process, @QHR, @DLP

Revision
41174 <https://svn.elca.ch/viewvc/secutix2-seb?rev=41174>
Author
tnh
Date
2016-05-13 08:40:34 +0200 (Fri, 13 May 2016)


Log Message

STX-65603 <https://jira.secutix.com/browse/STX-65603>  - remove check advantageLimitException when user login after buying on shop, processPayment step will check it.

Modified Paths


*	trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderFacadeInternalImpl.java <>
*	trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderServiceCoreImpl.java <>
*	trunk/app/tnseb/realtime/service/src/main/java/com/secutix/util/ExceptionHandlingHelper.java <>
*	trunk/app/tnseb/tnor/interface/src/main/java/com/secutix/exception/order/OrderControlException.java <>
*	trunk/app/tnseb/tnor/service/src/main/java/com/secutix/process/order/core/ContactServiceCoreImpl.java <>


Diff


Modified: trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderFacadeInternalImpl.java (41173 => 41174)



--- trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderFacadeInternalImpl.java	2016-05-12 15:10:14 UTC (rev 41173)

+++ trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderFacadeInternalImpl.java	2016-05-13 06:40:34 UTC (rev 41174)

@@ -501,11 +501,15 @@

 						// Call FMV158

 						externalOrderService.controlOrderBeforePayment(orderIdL.longValue());

 					} catch (OrderControlException e) {

+						if (e.getOriginalException() instanceof AdvantageLimitException) {

+							throw (AdvantageLimitException) e.getOriginalException();

+						}

 						if (e.getErrorCode() != null) {

 							result.setStatusCode(e.getErrorCode().getWsCode());

 						} else {

 							result.setStatusCode("error.order.failureControl");

 						}

+

 						result.setStatusDetail("Error while controlling the order before payment.");

 						return result;

 					}



Modified: trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderServiceCoreImpl.java (41173 => 41174)



--- trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderServiceCoreImpl.java	2016-05-12 15:10:14 UTC (rev 41173)

+++ trunk/app/tnseb/realtime/service/src/main/java/com/secutix/process/realtime/externalorder/ExternalOrderServiceCoreImpl.java	2016-05-13 06:40:34 UTC (rev 41174)

@@ -4663,13 +4663,7 @@

 				result.setStatusCode(StatusCode.ERROR_SUSPENDED_PRODUCT.getWsCode());

 				result.setStatusDetail("Error while updating order due to " + e.getMessage());

 				return result;

-			} else if (e instanceof AdvantageLimitException) {

-				ExceptionHandlingHelper.advantageLimitException(result, (AdvantageLimitException) e);

-				return result;

-			} else if (e instanceof SalesLimitException) {

-				ExceptionHandlingHelper.salesLimitException(result, (SalesLimitException) e);

-				return result;

-			}

+			}

 			result.setStatusCode(StatusCode.ERROR_CALL_EXCEPTION.getWsCode());

 			result.setStatusDetail("Error while updating order due to " + e.getMessage());

 			return result;



Modified: trunk/app/tnseb/realtime/service/src/main/java/com/secutix/util/ExceptionHandlingHelper.java (41173 => 41174)



--- trunk/app/tnseb/realtime/service/src/main/java/com/secutix/util/ExceptionHandlingHelper.java	2016-05-12 15:10:14 UTC (rev 41173)

+++ trunk/app/tnseb/realtime/service/src/main/java/com/secutix/util/ExceptionHandlingHelper.java	2016-05-13 06:40:34 UTC (rev 41174)

@@ -142,7 +142,7 @@

 		logExceptionsProperly(limitException, result);

 	}



-	public static <T extends WebMethodResult> void advantageLimitException(T result,

+	public static <T extends WebMethodResult> void advantageLimitException(T result,

 			final AdvantageLimitException limitException) {

 		final Map<String, Object> parameters = Maps.newHashMap();

 		parameters.put(PARAM_KEY_MESSAGE, "The request quantity is exceeded the advantage limit");

@@ -151,11 +151,17 @@

 		parameters.put(PARAM_KEY_ADVANTAGE_ID, limitException.getAdvantageId());

 		parameters.put(PARAM_KEY_AVAILABILITY, limitException.getQuota());



-		result.setStatusCode(StatusCode.ERROR_ORDER_CONTACT_LIMIT.getWsCode());

+		if (limitException.getOrderHistoryQuantity() != null) {

+			result.setStatusCode(StatusCode.ERROR_ORDER_CONTACT_LIMIT.getWsCode());

+		} else {

+			result.setStatusCode(limitException.getMin() != null && limitException.getRequested() != null

+					&& limitException.getMin() > limitException.getRequested()

+							? StatusCode.ERROR_ORDER_MIN_LIMIT.getWsCode() : StatusCode.ERROR_ORDER_LIMIT.getWsCode());

+		}

 		result.setStatusDetail(buildJSONStringMessage(parameters));

 		logExceptionsProperly(limitException, result);

 	}

-

+

 	private static void putCommonSalesLimitParameters(final Map<String, Object> parameters,

 			final SalesLimitException limitException) {

 		parameters.put(PARAM_KEY_REQUESTED_QUANTITY, limitException.getRequested());

@@ -166,7 +172,7 @@

 		parameters.put(PARAM_KEY_SEATCATEGORY_ID, limitException.getSeatCategoryId());

 		parameters.put(PARAM_KEY_AUDIENCE_CATEGORY_ID, limitException.getAudienceCategoryId());

 	}

-

+

 	public static <T extends WebMethodResult> void salesLimitException(T result, SalesLimitException limitException) {

 		final Integer minQty = limitException.getMin();

 		final Integer reqQty = limitException.getRequested();



Modified: trunk/app/tnseb/tnor/interface/src/main/java/com/secutix/exception/order/OrderControlException.java (41173 => 41174)



--- trunk/app/tnseb/tnor/interface/src/main/java/com/secutix/exception/order/OrderControlException.java	2016-05-12 15:10:14 UTC (rev 41173)

+++ trunk/app/tnseb/tnor/interface/src/main/java/com/secutix/exception/order/OrderControlException.java	2016-05-13 06:40:34 UTC (rev 41174)

@@ -8,12 +8,15 @@



 	private StatusCode errorCode;



+	private Throwable originalException;

+

 	public OrderControlException() {

 		super();

 	}



 	public OrderControlException(String message, Object[] parameters, Throwable exception) {

 		super(message, parameters, exception);

+		this.originalException = exception;

 	}



 	public OrderControlException(String message, Object[] parameters) {

@@ -22,6 +25,7 @@



 	public OrderControlException(String message, Throwable exception) {

 		super(message, exception);

+		this.originalException = exception;

 	}



 	public OrderControlException(String message) {

@@ -30,7 +34,7 @@



 	/**

 	 * Use this constructor if the exception has a specific code to be handled by the caller. (eg. ticket shop)

-	 *

+	 *

 	 * @param message

 	 * @param errorCode

 	 */

@@ -43,4 +47,12 @@

 	public StatusCode getErrorCode() {

 		return errorCode;

 	}

+

+	public Throwable getOriginalException() {

+		return originalException;

+	}

+

+	public void setOriginalException(Throwable ex) {

+		this.originalException = ex;

+	}

 }



Modified: trunk/app/tnseb/tnor/service/src/main/java/com/secutix/process/order/core/ContactServiceCoreImpl.java (41173 => 41174)



--- trunk/app/tnseb/tnor/service/src/main/java/com/secutix/process/order/core/ContactServiceCoreImpl.java	2016-05-12 15:10:14 UTC (rev 41173)

+++ trunk/app/tnseb/tnor/service/src/main/java/com/secutix/process/order/core/ContactServiceCoreImpl.java	2016-05-13 06:40:34 UTC (rev 41174)

@@ -136,11 +136,6 @@

 					// V2247

 					throwAdvantageLimitException(advantages);

 				}

-

-				final Collection<AbstractAdvantage> totalMaxNumberAdvantages = getTotalMaxNumberAdvantages(order);

-				for(AbstractAdvantage advantage : totalMaxNumberAdvantages) {

-					checkAdvantageQuantity(contactId, advantage, order);

-				}

 			}



 			// V261

@@ -191,33 +186,6 @@



 	}



-	private void checkAdvantageQuantity(final Long contactId, final AbstractAdvantage advantage, final Order order) throws AdvantageLimitException {

-		int totalMaxNumber = getSafeInteger(advantage.getTotalMaxNumber());

-

-		if (totalMaxNumber == 0) {

-			return;

-		}

-

-		int totalQuantity = 0;

-

-		for (final Operation operation : order.getOperations()) {

-			if (operation.getType() == OperationType.PRE_SALE && operation.getKind().isMainItem()

-					&& operation.getAdvantage() != null

-					&& advantage.getPk().getId().equals(operation.getAdvantage().getPk().getId())) {

-				totalQuantity += operation.getQuantity();

-			}

-		}

-

-		final int historyQuantity = countBoughtAdvantages(contactId, advantage.getPk().getId(), order);

-		totalQuantity += historyQuantity;

-		if (totalQuantity > totalMaxNumber) {

-			throw new AdvantageLimitException(advantage.getPk().getId(),

-					MultiLingualHelper.getTranslation(advantage.getInternalName()), totalQuantity, totalMaxNumber,

-					historyQuantity);

-		}

-

-	}

-

 	@SuppressWarnings("boxing")

 	private int getSafeInteger(Integer number) {

 		return number==null?NumberUtils.INTEGER_ZERO:number.intValue();

@@ -406,17 +374,6 @@

 		return result;

 	}



-	private List<AbstractAdvantage> getTotalMaxNumberAdvantages(final Order order) {

-		List<AbstractAdvantage> result = Lists.newArrayList();

-		for (Operation operation : order.getOperations()) {

-			if (operation.getAdvantage() != null

-					&& getSafeInteger(operation.getAdvantage().getTotalMaxNumber())>0) {

-				result.add(operation.getAbstractAdvantage());

-			}

-		}

-		return result;

-	}

-

 	@Override

 	public <T extends AbstractAdvantage> void throwAdvantageLimitException(Collection<T> usedAdvantages)

 			throws LimitedAdvantageLimitException {


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Friday, May 13, 2016 09:53
To:	Projet Secutix FW
Subject:	secutix2-fw: svn commit (pbl) [13635] STX-65876:  Enhance the stx_listFormFilter_contactComboBox widget by supporting define the context to use.

Categories:	@QHR, @DLP

Revision
13635 <https://svn.elca.ch/viewvc/secutix2-fw?rev=13635>
Author
pbl
Date
2016-05-13 04:52:35 +0200 (Fri, 13 May 2016)


Log Message

STX-65876 <https://jira.secutix.com/browse/STX-65876> : Enhance the stx_listFormFilter_contactComboBox widget by supporting define the context to use.

Modified Paths


*	trunk/app/fw/web/war/src/main/webapp/WEB-INF/tags/widget/stx_listFormFilter/stx_listFormFilter_contactComboBox.tag <>


Diff


Modified: trunk/app/fw/web/war/src/main/webapp/WEB-INF/tags/widget/stx_listFormFilter/stx_listFormFilter_contactComboBox.tag (13634 => 13635)



--- trunk/app/fw/web/war/src/main/webapp/WEB-INF/tags/widget/stx_listFormFilter/stx_listFormFilter_contactComboBox.tag	2016-05-12 22:01:47 UTC (rev 13634)

+++ trunk/app/fw/web/war/src/main/webapp/WEB-INF/tags/widget/stx_listFormFilter/stx_listFormFilter_contactComboBox.tag	2016-05-13 02:52:35 UTC (rev 13635)

@@ -1,4 +1,5 @@

 <%@ taglib prefix="fw" uri="http://www.elca.ch/secutix2" %>

+<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>



 <%-- if of the comboBox --%>

 <%@ attribute name="id" required="true"%>

@@ -35,15 +36,26 @@

 <%@ attribute name="searchContactUrl" required="false"%>

 <%@ attribute name="useNumberAsId" required="false"%>

 <%@ attribute name="contactRelayOnly" required="false"%>

+<%@ attribute name="isSalesContext" required="false" type="java.lang.Boolean"%>



 <%-- ===== JSTL TAGLIBS ================================================== --%>

 <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

 <c:url var="baseURL" value="/" />



+<c:set var="contextPrefix" value="" />

+<c:if test="${empty isSalesContext || isSalesContext == true}">

+	<c:set var="contextPrefix" value="/sc" />

+</c:if>

+

 <c:if test="${empty searchContactUrl}">

-    <c:set var="searchContactUrl" value="${fw:buildUrl('tnco', '/sc/contact/listBOContact.htm')}" />

+	<c:set var="searchContactUrl" value="${contextPrefix}/contact/listBOContact.htm" />

+	<c:set var="searchContactUrl" value="${fw:buildUrl('tnco', searchContactUrl)}" />

 </c:if>



+<c:set var="detailContactUrl" value="${contextPrefix}/contact/editContact.htm?refList=stx_ContactList&action=edit&entid=" />

+<c:set var="detailContactUrl" value="${fw:buildUrl('tnco', detailContactUrl)}" />

+

+

 <%-- ===== WIDGET CREATION =============================================== --%>

 new Stx.widget.listFormFilter.contactComboBox(

     '${id}', '${label}', ${dataSrcObject}, '${emptyText}', '${editable}', '${forceSelection}', '${allowBlank}',

@@ -52,7 +64,7 @@

     <%-- Additional configs --%>

     {

         searchContactUrl : "${searchContactUrl}",

-        detailContactUrl : "${fw:buildUrl('tnco', '/sc/contact/editContact.htm?refList=stx_ContactList&action=edit&entid=')}",

+        detailContactUrl : "${detailContactUrl}",

         useNumberAsId : ("${useNumberAsId}" === 'true'),

         contactRelayOnly : ("${contactRelayOnly}" === 'true'),

         <c:if test="${!empty columnspan}">columnspan : ${columnspan},</c:if>


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Thursday, May 12, 2016 16:07
To:	prj_Secutix2Vi
Subject:	secutix2-vi: svn commit (mnv) [1575] STX-65886:  modify list guide resource period with the corresponding competencies for visit pass

Categories:	@QHR, @DLP

Revision
1575 <https://svn.elca.ch/viewvc/secutix2-vi?rev=1575>
Author
mnv
Date
2016-05-12 11:07:29 +0200 (Thu, 12 May 2016)


Log Message

STX-65886 <https://jira.secutix.com/browse/STX-65886> : modify list guide resource period with the corresponding competencies for visit pass

Modified Paths


*	trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/resource/ListGuideResourcePeriodController.java <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels.properties <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_ca.properties <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_de.properties <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_en.properties <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_es.properties <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_fr.properties <>
*	trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_it.properties <>


Added Paths


*	trunk/app/tnvi/web/war/src/main/webapp/WEB-INF/jsps/listGuideResourcePeriod.jsp <>


Diff


Modified: trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/resource/ListGuideResourcePeriodController.java (1574 => 1575)



--- trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/resource/ListGuideResourcePeriodController.java	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/jar/src/main/java/com/secutix/web/controller/resource/ListGuideResourcePeriodController.java	2016-05-12 09:07:29 UTC (rev 1575)

@@ -6,16 +6,24 @@



 import org.hibernate.criterion.DetachedCriteria;

 import org.hibernate.criterion.Restrictions;

+import org.springframework.beans.BeanWrapper;

 import org.springframework.context.MessageSource;



 import com.secutix.model.resource.Guide;

 import com.secutix.model.resource.ResourcePeriod;

+import com.secutix.model.resource.ResourcePeriodType;

 import com.secutix.web.controller.list.AbstractListController;

+import com.secutix.web.controller.list.Column;

 import com.secutix.web.controller.list.ListColumnModel;

 import com.secutix.web.controller.list.ListColumnModel.ListColumnType;



 public class ListGuideResourcePeriodController extends AbstractListController<ResourcePeriod> {



+	private static final String WORKING_PERIOD_TYPE = "type";

+	private static final String ROW_CLASS = "rowClass";

+	private static final String AVAILABILITY_CLASS = "availabilityClass";

+	private static final String UNAVAILABILITY_CLASS = "unavailabilityClass";

+

 	public ListGuideResourcePeriodController() {

 		super(true, Guide.class);

 	}

@@ -24,14 +32,32 @@

 	protected ListColumnModel getColumnModel(HttpServletRequest request, MessageSource messageSource, Locale locale) {

 		ListColumnModel columnModel = new ListColumnModel(locale, messageSource, getSpecificCodePrefix());

 		columnModel.addIdColumn();

+		columnModel.addColumn(WORKING_PERIOD_TYPE, ListColumnType.TEXT);

 		columnModel.addColumn("reasonInternalName", ListColumnType.TEXT);

 		columnModel.addColumn("weekDay", ListColumnType.TEXT);

 		columnModel.addColumn("startDate", ListColumnType.DATE);

 		columnModel.addColumn("startTime", ListColumnType.TIME);

 		columnModel.addColumn("endDate", ListColumnType.DATE);

 		columnModel.addColumn("endTime", ListColumnType.TIME);

+		columnModel.addRawColumn(ROW_CLASS).sortable(false);

 		return columnModel;

 	}

+

+	@Override

+	protected Object getColumnValue(BeanWrapper wrappedEntity, ResourcePeriod entity, Column col,

+			MessageSource theMessageSource, Locale locale) {

+		if (ROW_CLASS.equals(col.getKey())) {

+			if (ResourcePeriodType.AVAILABILITY.equals(entity.getType())) {

+				return AVAILABILITY_CLASS;

+			} else {

+				return UNAVAILABILITY_CLASS;

+			}

+		} else if (WORKING_PERIOD_TYPE.equals(col.getKey())) {

+			return getMessageSource().getMessage("label.menu_editGuide." + entity.getType().name(), null, locale);

+		} else {

+			return super.getColumnValue(wrappedEntity, entity, col, theMessageSource, locale);

+		}

+	}



 	@Override

 	protected boolean showNew() {

@@ -54,13 +80,19 @@

 	}



 	@Override

+	protected String getEditUrl(HttpServletRequest request) {

+		return "editGuideResourcePeriod.htm";

+	}

+

+	@Override

+	protected String getViewName() {

+		return "listGuideResourcePeriod";

+	}

+

+	@SuppressWarnings("boxing")

+	@Override

 	protected void addSearchCriteria(HttpServletRequest request, DetachedCriteria criteria) {

 		super.addSearchCriteria(request, criteria);

 		criteria.add(Restrictions.eq("guideId", getParentIdAsLong(request)));

 	}

-

-	@Override

-	protected String getEditUrl(HttpServletRequest request) {

-		return "editGuideResourcePeriod.htm";

-	}

 }



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -29,7 +29,11 @@

 label.menu_editGuide.contact=Contact

 label.menu_editGuide.language=Languages

 label.menu_editGuide.visitTheme=Visit themes

-label.menu_editGuide.resourcePeriod=Unavailability

+label.menu_editGuide.resourcePeriod=Working periods

+label.menu_editGuide.UNAVAILABILITY=Unavailability

+label.menu_editGuide.AVAILABILITY=Availability

+label.menu_editGuide.NEW_UNAVAILABILITY=New Unavailability

+label.menu_editGuide.NEW_AVAILABILITY=New Availability



 # -----------------------------------------------------------------------------

 # Guide

@@ -56,6 +60,7 @@

 # -----------------------------------------------------------------------------

 label.ResourcePeriods=Unavailability periods

 # 72 | label.ResourcePeriod=Unavailability period

+label.ResourcePeriod.type=Type

 label.ResourcePeriod.reasonInternalName=Reason

 label.ResourcePeriod.weekDay=Week day

 label.ResourcePeriod.startTime=Start time

@@ -252,8 +257,8 @@

 label.Visit.newStart.date=#[label.Performance.newStart.date, C]#

 label.Visit.newStart.time=#[label.Performance.newStart.time, C]#



-

-label.menu_resources.VisitThemes=Visit Themes

-label.VisitThemes=Visit themes

-label.menu_resources.VisitThemes.keywords=theme

-label.VisitTheme=Visit theme

+

+label.menu_resources.VisitThemes=Visit Themes

+label.VisitThemes=Visit themes

+label.menu_resources.VisitThemes.keywords=theme

+label.VisitTheme=Visit theme



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_ca.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_ca.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_ca.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -29,7 +29,6 @@

 label.menu_editGuide.contact=Contacte

 label.menu_editGuide.language=Lleng�es

 label.menu_editGuide.visitTheme=Temes de visita

-label.menu_editGuide.resourcePeriod=No disponible

 # -----------------------------------------------------------------------------

 # Guide

 # -----------------------------------------------------------------------------



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_de.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_de.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_de.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -29,7 +29,6 @@

 label.menu_editGuide.contact=Kontakt

 label.menu_editGuide.language=Sprachen

 label.menu_editGuide.visitTheme=Thematik

-label.menu_editGuide.resourcePeriod=Nichtverf�gbarkeit

 # -----------------------------------------------------------------------------

 # Guide

 # -----------------------------------------------------------------------------



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_en.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_en.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_en.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -29,7 +29,6 @@

 label.menu_editGuide.contact=Contact

 label.menu_editGuide.language=Languages

 label.menu_editGuide.visitTheme=Visit themes

-label.menu_editGuide.resourcePeriod=Unavailability

 # -----------------------------------------------------------------------------

 # Guide

 # -----------------------------------------------------------------------------



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_es.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_es.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_es.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -29,7 +29,6 @@

 label.menu_editGuide.contact=Contacto

 label.menu_editGuide.language=Idiomas

 label.menu_editGuide.visitTheme=Temas de visita

-label.menu_editGuide.resourcePeriod=No disponible

 # -----------------------------------------------------------------------------

 # Guide

 # -----------------------------------------------------------------------------



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_fr.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_fr.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_fr.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -29,7 +29,6 @@

 label.menu_editGuide.contact=Contact

 label.menu_editGuide.language=Langues

 label.menu_editGuide.visitTheme=Th�matiques

-label.menu_editGuide.resourcePeriod=Indisponibilit�s

 # -----------------------------------------------------------------------------

 # Guide

 # -----------------------------------------------------------------------------



Modified: trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_it.properties (1574 => 1575)



--- trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_it.properties	2016-05-12 09:01:43 UTC (rev 1574)

+++ trunk/app/tnvi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnvi_labels_it.properties	2016-05-12 09:07:29 UTC (rev 1575)

@@ -34,7 +34,6 @@

 label.menu_editGuide.contact=Contact

 label.menu_editGuide.language=Languages

 label.menu_editGuide.visitTheme=Visit themes

-label.menu_editGuide.resourcePeriod=Unavailability



 # -----------------------------------------------------------------------------

 # Guide



Added: trunk/app/tnvi/web/war/src/main/webapp/WEB-INF/jsps/listGuideResourcePeriod.jsp (0 => 1575)



--- trunk/app/tnvi/web/war/src/main/webapp/WEB-INF/jsps/listGuideResourcePeriod.jsp	                        (rev 0)

+++ trunk/app/tnvi/web/war/src/main/webapp/WEB-INF/jsps/listGuideResourcePeriod.jsp	2016-05-12 09:07:29 UTC (rev 1575)

@@ -0,0 +1,125 @@

+<%@ taglib prefix="sp" uri="http://www.springframework.org/tags" %>

+<%@ taglib prefix="template" tagdir="/WEB-INF/tags/template"%>

+<%@ taglib prefix="widget" tagdir="/WEB-INF/tags/widget" %>

+<%@ taglib prefix="lff" tagdir="/WEB-INF/tags/widget/stx_listFormFilter"%>

+<%@ taglib prefix="fw" uri="http://www.elca.ch/secutix2" %>

+<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

+<%@ taglib prefix="la" tagdir="/WEB-INF/tags/widget/stx_listAction" %>

+

+<script type="text/javascript">

+    function showAddNewPopup(url, addNewCallBack) {

+        var options,

+        form,

+        popup,

+        scope;

+

+        options = {

+                popupHeight : 600,

+                popupWidth : 910,

+                url : url

+            };

+        popup = stx_windowOpenForceNew(url, '', options.popupWidth, options.popupHeight);

+

+        scope = this;

+        popup.onload = function(){

+            if (popup.stx_registerCallback) {

+                popup.stx_registerCallback('select', addNewCallBack, scope);

+            }

+        };

+    }

+

+    function addNewHandler(type) {

+        var addNewUrl = "${editUrl}";

+        addNewUrl = stx_addParameterInUrlIfNotPresent(addNewUrl, "action", "new");

+        addNewUrl = stx_addParameterInUrlIfNotPresent(addNewUrl, "workingPeriodType", type);

+        addNewUrl = stx_addParameterInUrlIfNotPresent(addNewUrl, "refList", "stx_${entityName}List");

+        showAddNewPopup(addNewUrl);

+    }

+</script>

+

+<template:stx_frame title="${pageTitle}">

+    <jsp:attribute name="center">

+        <style type="text/css">

+            .availabilityClass div {

+                color: green;

+            }

+            .unavailabilityClass div {

+                color: red;

+            }

+        </style>

+

+        <widget:stx_list id="${entityName}List"

+            columnModelSrcObject="${listColumnModel}"

+            dataSrcObject="${listDataModel}"

+            editUrl="${editUrl}"

+            isReadOnly="${isReadOnly}"

+            defaultCallTimeout="${defaultCallTimeout}"

+            showNumberOfItemsFooter="true">

+                <jsp:attribute name="listActions">

+                function(params, grid, additionalData) {

+                        var firstTb=[];

+

+                        <%-- new availability button --%>

+                        <c:if test="${showNew}">

+                            firstTb.push(<widget:stx_listAction

+                                id="${id}NewAvailability"

+                                refListId=""

+                                actionType="add"

+                                url=""

+                                addFilterParameters="false"

+                                css="stx_newButton"

+                                windowTarget="popup"

+                                actsOnLines="0">

+                                <jsp:attribute name="label">

+                                    <sp:message code="label.menu_editGuide.NEW_AVAILABILITY" javaScriptEscape="true"/>

+                                </jsp:attribute>

+                                <jsp:attribute name="clickCallback">

+                                    addNewHandler("AVAILABILITY");

+                                </jsp:attribute>

+                            </widget:stx_listAction>);

+                        </c:if>

+

+                        <%-- new unavailability button --%>

+                        <c:if test="${showNew}">

+                            firstTb.push(<widget:stx_listAction

+                                id="${id}NewUnavailability"

+                                refListId=""

+                                actionType="add"

+                                url=""

+                                addFilterParameters="false"

+                                css="stx_newButton"

+                                windowTarget="popup"

+                                actsOnLines="0">

+                                <jsp:attribute name="label">

+                                    <sp:message code="label.menu_editGuide.NEW_UNAVAILABILITY" javaScriptEscape="true"/>

+                                </jsp:attribute>

+                                <jsp:attribute name="clickCallback">

+                                    addNewHandler("UNAVAILABILITY");

+                                </jsp:attribute>

+                            </widget:stx_listAction>);

+                        </c:if>

+

+                        <%-- delete button --%>

+                        <c:if test="${showDelete}">

+                            firstTb.push(<la:stx_listAction_delete actsOnLines="1">

+                                <jsp:attribute name="confirmMessage">

+                                    <sp:message code="message.delete" javaScriptEscape="true"/>

+                                </jsp:attribute>

+                                <jsp:attribute name="messageTitle">

+                                    <sp:message code="message.${entityName}.confirmation.title" javaScriptEscape="true"/>

+                                </jsp:attribute>

+                            </la:stx_listAction_delete>);

+                        </c:if>

+

+                        <%-- duplicate button --%>

+                        <c:if test="${showDuplicate}">

+                            firstTb.push(<la:stx_listAction_duplicate />);

+                        </c:if>

+

+                        var tb = {"buttons" : firstTb};

+                        return [tb];

+                }

+                </jsp:attribute>

+         </widget:stx_list>

+    </jsp:attribute>

+</template:stx_frame>

\ No newline at end of file


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Thursday, May 12, 2016 16:02
To:	prj_Secutix2Vi
Subject:	secutix2-vi: svn commit (mnv) [1574] STX-65886:  Migration script to insert code AVAIL_REASON/ EMPTY_VALUE into INTERNAL_CODE

Categories:	@QHR, @DLP

Revision
1574 <https://svn.elca.ch/viewvc/secutix2-vi?rev=1574>
Author
mnv
Date
2016-05-12 11:01:43 +0200 (Thu, 12 May 2016)


Log Message

STX-65886 <https://jira.secutix.com/browse/STX-65886> : Migration script to insert code AVAIL_REASON/EMPTY_VALUE into INTERNAL_CODE

Added Paths


*	trunk/app/tnvi/model/src/main/resources/etc/sql/migration_scripts/STX-65886-pre.sql <>


Diff


Added: trunk/app/tnvi/model/src/main/resources/etc/sql/migration_scripts/STX-65886-pre.sql (0 => 1574)



--- trunk/app/tnvi/model/src/main/resources/etc/sql/migration_scripts/STX-65886-pre.sql	                        (rev 0)

+++ trunk/app/tnvi/model/src/main/resources/etc/sql/migration_scripts/STX-65886-pre.sql	2016-05-12 09:01:43 UTC (rev 1574)

@@ -0,0 +1,38 @@

+/* Keep this comment on first line - file must be UTF-8 WITHOUT bom encoded.

+ *

+ * Check for guidelines here: http://wiki.elca.ch/twiki/secutix/bin/view/SecuTix2/DatabaseMigrationGuidelines

+ *

+ * Description (optional)

+ *

+ * $Rev$

+ * $URL$

+ * $Date$

+ * $Author$

+ */

+

+select 'Starting TnVI/STX-65886-pre' from DUAL;

+

+DECLARE

+    num_row  integer := 0;

+begin

+    for instit in (select instit_code from institution)

+    loop

+        SELECT COUNT(*) INTO num_row FROM INTERNAL_CODE WHERE INSTIT_CODE = instit.INSTIT_CODE AND CODE = 'AVAIL_REASON/EMPTY_VALUE';

+            IF (num_row = 0) THEN

+                insertInternalCode(instit.instit_code, 'AVAIL_REASON', 'EMPTY_VALUE', 1, 'T', 'F', 'TEXT_IC',

+                    'fr', '-',

+                    'en', '-',

+                    'de', '-',

+                    'es', '-',

+                    'ca', '-',

+                    'it', '-',

+                    'STX-65886-pre');

+            END IF;

+        commit;

+    end loop;

+end;

+/

+

+select 'Finished TnVI/STX-65886-pre' from DUAL;

+

+/* Please leave an empty line after this comment */

Property changes on: trunk/app/tnvi/model/src/main/resources/etc/sql/migration_scripts/STX-65886-pre.sql

___________________________________________________________________



Added: svn:keywords


Added: svn:eol-style

ELCA Subversion service
From:	noreply@elca.ch
Sent:	Wednesday, May 11, 2016 17:14
To:	Projet Secutix FW
Subject:	secutix2-fw: svn commit (dlp) [13629]  STX-65850 keep the key same as header key.

Categories:	@QHR, @DLP

Revision
13629 <https://svn.elca.ch/viewvc/secutix2-fw?rev=13629>
Author
dlp
Date
2016-05-11 12:13:33 +0200 (Wed, 11 May 2016)


Log Message

STX-65850 <https://jira.secutix.com/browse/STX-65850>  keep the key same as header key.

Modified Paths


*	trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java <>


Diff


Modified: trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java (13628 => 13629)



--- trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java	2016-05-11 08:36:20 UTC (rev 13628)

+++ trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java	2016-05-11 10:13:33 UTC (rev 13629)

@@ -82,9 +82,9 @@

 		contextMap.put(ReducedContextProvider.CONTEXT_DEBUG_REQUEST_ID, contextProvider.getCurrentDebugRequestId());



 		if (StringUtils.hasText(contextProvider.getCurrentDebugRequestId())

-				&& contextProvider.getCurrentDebugRequestId().startsWith("RED_DEV")) {

+				&& contextProvider.getCurrentDebugRequestId().startsWith("RED-DEV")) {

 			// this context key aim to allow redirect to developer pc (through http header) for hessian calls by nginx

-			contextMap.put("RED_DEV",  contextProvider.getCurrentDebugRequestId().split(",")[0]);

+			contextMap.put("RED-DEV",  contextProvider.getCurrentDebugRequestId().split(",")[0]);

 		}



 		if (LOGGER.isDebugEnabled()) {


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Wednesday, May 11, 2016 15:36
To:	Projet Secutix FW
Subject:	secutix2-fw: svn commit (dlp) [13628]  STX-65850 special key to indicate for redirection on integration

Categories:	@QHR, @DLP

Revision
13628 <https://svn.elca.ch/viewvc/secutix2-fw?rev=13628>
Author
dlp
Date
2016-05-11 10:36:20 +0200 (Wed, 11 May 2016)


Log Message

STX-65850 <https://jira.secutix.com/browse/STX-65850>  special key to indicate for redirection on integration

Modified Paths


*	trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java <>


Diff


Modified: trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java (13627 => 13628)



--- trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java	2016-05-11 06:51:59 UTC (rev 13627)

+++ trunk/app/fw/remoting/src/main/java/com/secutix/util/ContextProviderImplicitContextPasser.java	2016-05-11 08:36:20 UTC (rev 13628)

@@ -81,6 +81,12 @@



 		contextMap.put(ReducedContextProvider.CONTEXT_DEBUG_REQUEST_ID, contextProvider.getCurrentDebugRequestId());



+		if (StringUtils.hasText(contextProvider.getCurrentDebugRequestId())

+				&& contextProvider.getCurrentDebugRequestId().startsWith("RED_DEV")) {

+			// this context key aim to allow redirect to developer pc (through http header) for hessian calls by nginx

+			contextMap.put("RED_DEV",  contextProvider.getCurrentDebugRequestId().split(",")[0]);

+		}

+

 		if (LOGGER.isDebugEnabled()) {

 			LOGGER.debug("getImplicitlyPassedContext(): contextMap = " + mapToString(contextMap));

 		}


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Wednesday, May 11, 2016 10:24
To:	Projet Secutix2 VE
Subject:	secutix2-ve: svn commit (tvp) [6731] STX-65725:  SVG seatmap - rotate ellipse with configuration angle.

Categories:	@QHR, @DLP

Revision
6731 <https://svn.elca.ch/viewvc/secutix2-ve?rev=6731>
Author
tvp
Date
2016-05-11 05:23:55 +0200 (Wed, 11 May 2016)


Log Message

STX-65725 <https://jira.secutix.com/browse/STX-65725> : SVG seatmap - rotate ellipse with configuration angle.

Modified Paths


*	trunk/app/tnve/web/svgseatmap/src/main/includes/widget/stx_svgSeatMap/stx_svgSeatMap.js <>


Diff


Modified: trunk/app/tnve/web/svgseatmap/src/main/includes/widget/stx_svgSeatMap/stx_svgSeatMap.js (6730 => 6731)



--- trunk/app/tnve/web/svgseatmap/src/main/includes/widget/stx_svgSeatMap/stx_svgSeatMap.js	2016-05-06 07:58:42 UTC (rev 6730)

+++ trunk/app/tnve/web/svgseatmap/src/main/includes/widget/stx_svgSeatMap/stx_svgSeatMap.js	2016-05-11 03:23:55 UTC (rev 6731)

@@ -12,7 +12,7 @@

     this.constrainedMode = false;

     this.filterGroup = null;

     this.switchConfigAllowed = true;

-

+

     // timeout used to refresh the minimap on resize.

     // used to free the timeout if the screen is closed

     this.redrawTimeout = null;

@@ -560,8 +560,8 @@

     };



     this.updateMode(this.modeEnum[this.config.mode]);

-



+

 };



 // class

@@ -3456,7 +3456,7 @@



         needToLoad = !this.publicScreen || this.publicScreen.closed || this.publicScreen.location.href != publicScreenJspPath;

         this.publicScreen = stx_showOnPublicScreen({

-            priority : 2,

+            priority : 2,

             url : publicScreenJspPath,

             onload : function() {

                 dfd.resolve();

@@ -6024,6 +6024,9 @@

         d3Ellipse.attr('cy', ellipse.centerY);

         d3Ellipse.attr('rx', ellipse.width / 2);

         d3Ellipse.attr('ry', ellipse.height / 2);

+        d3Ellipse.attr('transform', function() {

+            return 'rotate(' + (ellipse.direction || 0) + ', ' + ellipse.centerX + ', ' + ellipse.centerY + ')';

+        });

     },



     /**

@@ -6094,7 +6097,7 @@

     },



     isSmallMap : function() {

-        return this.parameters.seatMap.seatMapStatistics.total <= 3000;

+        return stx_getProperty(this.parameters, 'seatMap.seatMapStatistics.total', 0) <= 3000;

     },



     mapRequiresToHideDetails : function() {


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Tuesday, May 10, 2016 17:25
To:	prj_Secutix2Bo
Subject:	secutix2-bo: svn commit (tvp) [22547] STX-65833: Volunteer screen:  Handle concurrent update.

Follow Up Flag:	Follow up
Flag Status:	Flagged

Categories:	Box office, @TAA

Revision
22547 <https://svn.elca.ch/viewvc/secutix2-bo?rev=22547>
Author
tvp
Date
2016-05-10 12:25:21 +0200 (Tue, 10 May 2016)


Log Message

STX-65833 <https://jira.secutix.com/browse/STX-65833> : Volunteer screen: Handle concurrent update.

Modified Paths


*	trunk/app/tnbo/web/war/src/main/includes/widget/stx_ticketCollectionCollectTickets/stx_ticketCollectionCollectTickets.js <>


Diff


Modified: trunk/app/tnbo/web/war/src/main/includes/widget/stx_ticketCollectionCollectTickets/stx_ticketCollectionCollectTickets.js (22546 => 22547)



--- trunk/app/tnbo/web/war/src/main/includes/widget/stx_ticketCollectionCollectTickets/stx_ticketCollectionCollectTickets.js	2016-05-10 09:50:01 UTC (rev 22546)

+++ trunk/app/tnbo/web/war/src/main/includes/widget/stx_ticketCollectionCollectTickets/stx_ticketCollectionCollectTickets.js	2016-05-10 10:25:21 UTC (rev 22547)

@@ -1341,6 +1341,10 @@

                         shipmentPrintedCallback.createDelegate(this),

                         this.hasMoreThanOneSeasonTicketToPrint? this.perPerfSeasonTicketPrintOrderRadio.getGroupValue() : null);

             }

+        } else {

+            //May have business exception.

+            //Close popup and refresh ticket list.

+            this.backToPreviousSearchBtnHandler();

         }



         this.onProcessTicketSuccess();


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Tuesday, May 10, 2016 13:55
To:	prj_Secutix2Bi
Subject:	secutix2-bi: svn commit (thu) [8721] STX-65438: [Cashdesk Closure]  Update default parameters

Categories:	Report, @THP, @QHR

Revision
8721 <https://svn.elca.ch/viewvc/secutix2-bi?rev=8721>
Author
thu
Date
2016-05-10 08:55:10 +0200 (Tue, 10 May 2016)


Log Message

STX-65438 <https://jira.secutix.com/browse/STX-65438> : [Cashdesk Closure] Update default parameters

Modified Paths


*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels.properties <>
*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_ca.properties <>
*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_de.properties <>
*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_en.properties <>
*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_es.properties <>
*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_fr.properties <>
*	trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_it.properties <>
*	trunk/app/tnbi/web/war/src/main/webapp/WEB-INF/ssrsReports/standardReports/ACCOUNTING/cashDeskClosure.rdl <>


Diff


Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3689,4 +3689,6 @@

 label.reportFields.PRODUCT_STATE=Product state

 label.reportFields.PERFORMANCE_STATE=Performance state

 label.reportFields.EVENT_STATE=Event state

-

+label.reportFields.CASH_DESK=Cash desk

+label.reportFields.CASH_DESK_W_OPERATOR=Cash desk with operator

+label.reportFields.CASH_DESK_WO_OPERATOR=Cash desk without operator



Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_ca.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_ca.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_ca.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3436,3 +3436,6 @@

 label.listReport.deprecationWarning=The old reports with indication "no longer supported" will soon be removed.You are advised to use new reports by clicking "New" & referring to the {0} which contains the mapping between old and new reports.

 label.listReport.mappingDocumentation=documentation

 label.listReport.deprecated_level1=Report not supported

+label.reportFields.CASH_DESK=Caixa

+label.reportFields.CASH_DESK_W_OPERATOR=Caixes amb operadors

+label.reportFields.CASH_DESK_WO_OPERATOR=Caixes sense operadors



Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_de.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_de.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_de.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3416,3 +3416,6 @@

 label.listReport.deprecationWarning=Die alten Berichte mit dem Vermerk "nicht l�nger unterst�tzt" werden bald entfernt. Wir empfehlen die neuen Berichte zu verwenden, durch einen Klick auf "Neu" und den Verweis auf {0}, welcher das Mapping zwischen alten und neuen Berichten enth�lt.

 label.listReport.mappingDocumentation=Dokumentation

 label.listReport.deprecated_level1=Bericht nicht unterst�tzt

+label.reportFields.CASH_DESK=Kasse

+label.reportFields.CASH_DESK_W_OPERATOR=Kasse mit Benutzer

+label.reportFields.CASH_DESK_WO_OPERATOR=Kasse ohne Benutzer



Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_en.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_en.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_en.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3638,6 +3638,9 @@

 label.reportFields.PERFORMANCE_STATE=Performance state



 label.reportFields.EVENT_STATE=Event state

+label.reportFields.CASH_DESK=Cash desk

+label.reportFields.CASH_DESK_W_OPERATOR=Cash desk with operator

+label.reportFields.CASH_DESK_WO_OPERATOR=Cash desk without operator



 label.report.PlanningGuides.visits_label=Visits:

 label.report.PlanningGuides.activities=Activities:



Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_es.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_es.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_es.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3432,6 +3432,9 @@

 label.reportFields.PRODUCT_STATE=Estado del producto

 label.reportFields.PERFORMANCE_STATE=Estado de la sesi�n

 label.reportFields.EVENT_STATE=Estado del evento

+label.reportFields.CASH_DESK=Caja

+label.reportFields.CASH_DESK_W_OPERATOR=Caja con operadores

+label.reportFields.CASH_DESK_WO_OPERATOR=Cajas sin operadores

 label.report.PlanningGuides.visits_label=Visitas:

 label.report.PlanningGuides.activities=Actividades:

 label.ReportOptionParameter.visits=###Visitas no seleccionadas###Visitas seleccionadas



Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_fr.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_fr.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_fr.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3659,6 +3659,9 @@

 label.reportFields.PRODUCT_STATE=�tat du produit

 label.reportFields.PERFORMANCE_STATE=�tat de la s�ance

 label.reportFields.EVENT_STATE=�tat de l''�v�nement

+label.reportFields.CASH_DESK=Caisses

+label.reportFields.CASH_DESK_W_OPERATOR=Caisses avec op�rateurs

+label.reportFields.CASH_DESK_WO_OPERATOR=Caisses sans op�rateurs

 label.report.PlanningGuides.visits_label=Visites:

 label.report.PlanningGuides.activities=Activit�s :

 label.ReportOptionParameter.visits=###Visites pas s�lectionn�es###Visites s�lectionn�es



Modified: trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_it.properties (8720 => 8721)



--- trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_it.properties	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/resources/src/main/webapp/WEB-INF/i18n/label/tnbi_labels_it.properties	2016-05-10 06:55:10 UTC (rev 8721)

@@ -3504,7 +3504,10 @@

 label.reportFields.PRODUCT_STATE=Stato del prodotto

 label.reportFields.PERFORMANCE_STATE=Stato sessione



-label.reportFields.EVENT_STATE=Event state

+label.reportFields.EVENT_STATE=Event state

+label.reportFields.CASH_DESK=Cash desk

+label.reportFields.CASH_DESK_W_OPERATOR=Cash desk with operator

+label.reportFields.CASH_DESK_WO_OPERATOR=Cash desk without operator



 label.report.PlanningGuides.visits_label=Visits:

 label.report.PlanningGuides.activities=Activities:



Modified: trunk/app/tnbi/web/war/src/main/webapp/WEB-INF/ssrsReports/standardReports/ACCOUNTING/cashDeskClosure.rdl (8720 => 8721)



--- trunk/app/tnbi/web/war/src/main/webapp/WEB-INF/ssrsReports/standardReports/ACCOUNTING/cashDeskClosure.rdl	2016-05-10 03:45:28 UTC (rev 8720)

+++ trunk/app/tnbi/web/war/src/main/webapp/WEB-INF/ssrsReports/standardReports/ACCOUNTING/cashDeskClosure.rdl	2016-05-10 06:55:10 UTC (rev 8721)

@@ -179,9 +179,6 @@

       <Query>

         <DataSourceName>BIL</DataSourceName>

         <QueryParameters>

-          <QueryParameter Name=":currentOperatorId">

-            <Value>=Parameters!currentOperatorId.Value</Value>

-          </QueryParameter>

           <QueryParameter Name=":institutionCode">

             <Value>=Parameters!institutionCode.Value</Value>

           </QueryParameter>

@@ -191,6 +188,14 @@

           <QueryParameter Name=":noneLabel">

             <Value>=Parameters!noneLabel.Label</Value>

           </QueryParameter>

+          <QueryParameter Name=":currentUser">

+            <Value>=Parameters!currentUser.Value</Value>

+            <rd:UserDefined>true</rd:UserDefined>

+          </QueryParameter>

+          <QueryParameter Name=":organizationId">

+            <Value>=Parameters!organizationId.Value</Value>

+            <rd:UserDefined>true</rd:UserDefined>

+          </QueryParameter>

         </QueryParameters>

         <CommandText>select * from (

 SELECT o.operator_id, ut.user_id, ut.login FROM (SELECT DISTINCT(sub_operator_id) FROM (

@@ -199,20 +204,20 @@

 	LEFT JOIN at_responsibility_operator o1 ON o1.instit_code=o.instit_code AND o1.operator_id=o.operator_id

 	LEFT JOIN at_responsibility_operator o2 ON o1.instit_code=o2.instit_code AND o1.sub_operator_id=o2.operator_id

 	LEFT JOIN at_responsibility_operator o3 ON o3.instit_code=o2.instit_code AND o2.sub_operator_id=o3.operator_id

-	WHERE o.operator_id =:currentOperatorId AND o.instit_code=:institutionCode

+	WHERE o.instit_code=:institutionCode and o.ORGANIZ_ID=:organizationId

 	UNION ALL

 	SELECT o2.sub_operator_id

 	FROM operator o

 	INNER JOIN at_responsibility_operator o1 ON o1.instit_code=o.instit_code AND o1.operator_id=o.operator_id

 	INNER JOIN at_responsibility_operator o2 ON o1.instit_code=o2.instit_code AND o1.sub_operator_id=o2.operator_id

-	WHERE o.operator_id =:currentOperatorId AND o.instit_code=:institutionCode

+	WHERE o.instit_code=:institutionCode and o.ORGANIZ_ID=:organizationId

 	UNION ALL

 	SELECT o3.sub_operator_id

 	FROM operator o

 	INNER JOIN at_responsibility_operator o1 ON o1.instit_code=o.instit_code AND o1.operator_id=o.operator_id

 	INNER JOIN at_responsibility_operator o2 ON o1.instit_code=o2.instit_code AND o1.sub_operator_id=o2.operator_id

 	INNER JOIN at_responsibility_operator o3 ON o3.instit_code=o2.instit_code AND o2.sub_operator_id=o3.operator_id

-	WHERE o.operator_id =:currentOperatorId AND o.instit_code=:institutionCode

+	WHERE o.instit_code=:institutionCode and o.ORGANIZ_ID=:organizationId

 	UNION ALL

 	SELECT o4.sub_operator_id

 	FROM operator o

@@ -220,7 +225,7 @@

 	INNER JOIN at_responsibility_operator o2 ON o1.instit_code=o2.instit_code AND o1.sub_operator_id=o2.operator_id

 	INNER JOIN at_responsibility_operator o3 ON o3.instit_code=o2.instit_code AND o2.sub_operator_id=o3.operator_id

 	INNER JOIN at_responsibility_operator o4 ON o4.instit_code=o3.instit_code AND o3.sub_operator_id=o4.operator_id

-	WHERE o.operator_id =:currentOperatorId AND o.instit_code=:institutionCode

+	WHERE o.instit_code=:institutionCode and o.ORGANIZ_ID=:organizationId

 	UNION ALL

 	SELECT o5.sub_operator_id

 	FROM operator o

@@ -229,11 +234,12 @@

 	INNER JOIN at_responsibility_operator o3 ON o3.instit_code=o2.instit_code AND o2.sub_operator_id=o3.operator_id

 	INNER JOIN at_responsibility_operator o4 ON o4.instit_code=o3.instit_code AND o3.sub_operator_id=o4.operator_id

 	INNER JOIN at_responsibility_operator o5 ON o5.instit_code=o4.instit_code AND o4.sub_operator_id=o5.operator_id

-	WHERE o.operator_id =:currentOperatorId AND o.instit_code=:institutionCode

+	WHERE o.instit_code=:institutionCode and o.ORGANIZ_ID=:organizationId

 	UNION ALL

-	SELECT op.operator_id FROM operator op WHERE op.instit_code = :institutionCode and op.operator_id = :currentOperatorId)) temp

+	SELECT op.operator_id FROM operator op WHERE op.instit_code = :institutionCode  and op.ORGANIZ_ID=:organizationId)) temp

 INNER JOIN operator o ON o.instit_code = :institutionCode AND o.operator_id = temp.sub_operator_id

 LEFT JOIN user_table ut ON o.instit_code = ut.instit_code AND o.user_id = ut.user_id

+WHERE to_char(-1) = (:currentUser) OR  ut.login IN (:currentUser)

   UNION ALL

   SELECT TO_NUMBER(:noneId) AS operator_id, TO_NUMBER(:noneId) AS user_id, :noneLabel AS login FROM DUAL

  )

@@ -307,26 +313,6 @@

         </Field>

       </Fields>

     </DataSet>

-    <DataSet Name="currentOperator">

-      <Query>

-        <DataSourceName>BIL</DataSourceName>

-        <QueryParameters>

-          <QueryParameter Name=":institutionCode">

-            <Value>=Parameters!institutionCode.Value</Value>

-          </QueryParameter>

-          <QueryParameter Name=":currentUser">

-            <Value>=IIF(Instr(User!UserID, "#") > 0,Split(User!UserID,"#").GetValue(1),User!UserID)</Value>

-          </QueryParameter>

-        </QueryParameters>

-        <CommandText>SELECT operator_id FROM operator o JOIN user_table ut ON o.instit_code = ut.instit_code AND o.user_id = ut.user_id WHERE o.instit_code =:institutionCode AND ut.login IN (:currentUser)</CommandText>

-      </Query>

-      <Fields>

-        <Field Name="OPERATOR_ID">

-          <DataField>OPERATOR_ID</DataField>

-          <rd:TypeName>System.Decimal</rd:TypeName>

-        </Field>

-      </Fields>

-    </DataSet>

     <DataSet Name="cashDesks">

       <Query>

         <DataSourceName>BIL</DataSourceName>

@@ -426,7 +412,7 @@

             <Value>=Parameters!institutionCode.Value</Value>

           </QueryParameter>

         </QueryParameters>

-        <CommandText>select case when pos_id is not null then 'F' else 'T' end as is_with_operator from cash_desk where instit_code = :institutionCode and cashdesk_id = :cashDeskId</CommandText>

+        <CommandText>=IIF(IsNothing(Parameters!cashDeskId.Value) or Parameters!cashDeskId.Value = "-2", "select '-2' as  is_with_operator,  :institutionCode as instit_code, :cashDeskId as cash_id from dual", "select case when pos_id is not null then 'F' else 'T' end as is_with_operator from cash_desk where instit_code = :institutionCode and cashdesk_id = :cashDeskId")</CommandText>

       </Query>

       <Fields>

         <Field Name="IS_WITH_OPERATOR">

@@ -449,19 +435,16 @@

             <Value>=Parameters!cashDeskId.Value</Value>

           </QueryParameter>

         </QueryParameters>

-        <CommandText>select cd.state, ict.value as label from cash_desk cd

-LEFT JOIN INTERNAL_CODE_TRANS ict

-          ON (ict.instit_code=cd.instit_code AND ict.language_code =:language and ict.code='com.secutix.service.dto.payment.CashDeskStateEnum/' || cd.state)

-where cd.instit_code = :institutionCode and cd.cashdesk_id = :cashDeskId

-</CommandText>

+        <CommandText>= IIF(IsNothing(Parameters!cashDeskId.Value) or Parameters!cashDeskId.Value = "-2", "select -2 as s_state, '-2' as label, :institutionCode as instit_code, :cashDeskId as cash_id, :language as lang from dual",

+"select cd.state as s_state, ict.value as s_label from cash_desk cd LEFT JOIN INTERNAL_CODE_TRANS ict ON (ict.instit_code=cd.instit_code AND ict.language_code =:language and ict.code='com.secutix.service.dto.payment.CashDeskStateEnum/' || cd.state) where cd.instit_code = :institutionCode and cd.cashdesk_id = :cashDeskId")</CommandText>

       </Query>

       <Fields>

         <Field Name="STATE">

-          <DataField>STATE</DataField>

+          <DataField>S_STATE</DataField>

           <rd:TypeName>System.String</rd:TypeName>

         </Field>

         <Field Name="LABEL">

-          <DataField>LABEL</DataField>

+          <DataField>S_LABEL</DataField>

           <rd:TypeName>System.String</rd:TypeName>

         </Field>

       </Fields>

@@ -485,9 +468,6 @@

           <QueryParameter Name=":language">

             <Value>=Parameters!language.Value</Value>

           </QueryParameter>

-          <QueryParameter Name=":c_with_op">

-            <Value>=Parameters!c_with_op.Value</Value>

-          </QueryParameter>

           <QueryParameter Name=":c_inter_wd_id">

             <Value>=Parameters!c_inter_wd_id.Value</Value>

           </QueryParameter>

@@ -522,6 +502,12 @@

   where cd.INSTIT_CODE = :institutionCode AND t_organization_id = :organizationId AND cd.CASHDESK_ID IN (:cashDeskId)

 ),



+is_with_operator AS (

+	select (case when pos_id is not null then 'F' else 'T' end) as is_with_operator

+	from cash_desk

+	where instit_code = :institutionCode and cashdesk_id = :cashDeskId

+),

+

 /*

 PART 1 &gt; SECTION 1

     gl1       = '&lt;cashdesk_id&gt;'

@@ -560,7 +546,7 @@

                 join INSTITUTION    ins on (ins.instit_code = cd.instit_code)

                 join PAYMENT        pa  on (cd.cashdesk_id  = pa.cashdesk_id    and cd.instit_code = pa.instit_code)

                 join POINT_OF_SALES pos on (pa.pos_id       = pos.pos_id        and pa.instit_code = pos.instit_code)

-            where :c_with_op = 'T' and pa.cashdesk_id = cd.CASHDESK_ID

+            where (select is_with_operator from is_with_operator where rownum =1) = 'T' and pa.cashdesk_id = cd.CASHDESK_ID

             order by pos_name

         )

     )

@@ -595,7 +581,7 @@

         UPPER(ins.INTERNAL_LANGUAGE_L3), NVL(sc.INTERNAL_NAME_L3, sc.INTERNAL_NAME_L1),

         UPPER(ins.INTERNAL_LANGUAGE_L4), NVL(sc.INTERNAL_NAME_L4, sc.INTERNAL_NAME_L1),

         UPPER(ins.INTERNAL_LANGUAGE_L5), NVL(sc.INTERNAL_NAME_L5, sc.INTERNAL_NAME_L1))     as sales_channel,

-    DECODE(:c_with_op,

+    DECODE((select is_with_operator from is_with_operator where rownum =1),

         'F', DECODE(UPPER(:language),

                 UPPER(ins.INTERNAL_LANGUAGE_L1), pos.INTERNAL_NAME_L1,

                 UPPER(ins.INTERNAL_LANGUAGE_L2), NVL(pos.INTERNAL_NAME_L2, pos.INTERNAL_NAME_L1),

@@ -609,8 +595,8 @@

   FROM              MCDB            cd

     JOIN            INSTITUTION     ins ON (ins.INSTIT_CODE = cd.INSTIT_CODE)

     LEFT OUTER JOIN SALES_CHANNEL   sc  ON (sc.SALCHAN_ID   = cd.SALCHAN_ID     AND sc.INSTIT_CODE  = cd.INSTIT_CODE)

-    LEFT OUTER JOIN POINT_OF_SALES  pos ON (pos.POS_ID      = cd.POS_ID         AND pos.INSTIT_CODE = cd.INSTIT_CODE AND :c_with_op = 'F')

-    LEFT OUTER JOIN P1S1_POS_REF    pr  ON (pr.CASHDESK_ID  = cd.CASHDESK_ID    AND pr.INSTIT_CODE  = cd.INSTIT_CODE AND :c_with_op = 'T')

+    LEFT OUTER JOIN POINT_OF_SALES  pos ON (pos.POS_ID      = cd.POS_ID         AND pos.INSTIT_CODE = cd.INSTIT_CODE AND (select is_with_operator from is_with_operator where rownum =1) = 'F')

+    LEFT OUTER JOIN P1S1_POS_REF    pr  ON (pr.CASHDESK_ID  = cd.CASHDESK_ID    AND pr.INSTIT_CODE  = cd.INSTIT_CODE AND (select is_with_operator from is_with_operator where rownum =1) = 'T')



 ),



@@ -640,14 +626,14 @@

 			)

 		)

 		AND :c_check &lt;&gt; 'VERIFY'    /*We do not show this section in verify mode*/

-		AND :c_with_op = 'T'        /*we can NEVER perform INTERMEDIATE withdraw for cash desk without operator, so do not show this section*/

+		AND (select is_with_operator from is_with_operator where rownum =1) = 'T'        /*we can NEVER perform INTERMEDIATE withdraw for cash desk without operator, so do not show this section*/

 ),



 MCD2345 AS ( /* mini cash desk for part 2, 3, 4, 5 */

     select  *

     from    MCDB                mcdb

     where   :c_instcode_ex = 'ONP' /* part 2, 3, 4, 5 are for ONP only */

-        and :c_with_op = 'T' /* in case of without operator, we don't have data for these sections */

+        and (select is_with_operator from is_with_operator where rownum =1) = 'T' /* in case of without operator, we don't have data for these sections */

 ),

 MCD AS (

     select  *

@@ -796,7 +782,7 @@

       from POINT_OF_SALES pos

         join POINT_OF_SALES_CURRENCY posc   on (posc.POS_ID = pos.POS_ID and posc.instit_code = pos.instit_code)

         join MCD                     mcd    on (pos.POS_ID = mcd.POS_ID and pos.instit_code = mcd.instit_code)

-      where :c_with_op = 'T'

+      where (select is_with_operator from is_with_operator where rownum =1) = 'T'

     )

     UNION ALL

     (

@@ -806,7 +792,7 @@

       from AUTHORIZED_CURRENCY ac

         join institution ins    on (ac.instit_code = ins.instit_code)

         join MCD            mcd on (ins.instit_code = mcd.INSTIT_CODE)

-      where :c_with_op = 'F'

+      where (select is_with_operator from is_with_operator where rownum =1) = 'F'

     )

     UNION ALL

     (

@@ -1139,7 +1125,7 @@

             left outer join     TICKET_SUPPORT          supp    on ((tik.ticksupport_id = supp.ticksupport_id and tik.ticket_id is not null and tik.instit_code = supp.instit_code)

                                                                     or (tik.ticket_id is null and cdwl.ticksupport_id = supp.ticksupport_id  and cdwl.instit_code = supp.instit_code))

 			left outer join INTERNAL_CODE_TRANS ict ON (ict.CODE = supp.INTERNAL_NAME_IC AND ict.INSTIT_CODE = supp.INSTIT_CODE AND language_code = :language)

-        where   :c_with_op = 'T' /*for "with operator" only*/

+        where   (select is_with_operator from is_with_operator where rownum =1) = 'T' /*for "with operator" only*/

             and ((

                     cdwl.DETAIL_CHECK = 'T' and tik.TICKET_ID is not null and tik.PRINTING_DATE is not null

                 ) or (

@@ -1241,7 +1227,7 @@

         join            MCD                       mcd  on (    tik.CANCELLATION_CASHDESKID = mcd.cashdesk_id

                                                            and tik.instit_code             = mcd.instit_code   )

         join            INSTITUTION               inst on (    inst.instit_code            = mcd.instit_code   )

-      where :c_with_op = 'T' /*for "with operator" only*/

+      where (select is_with_operator from is_with_operator where rownum =1) = 'T' /*for "with operator" only*/

     )

     group by instit_code, cashdesk_id, tik_printing_state, currency_code, cashdesk_state, supp

 ),

@@ -1470,7 +1456,7 @@

             0                               as ea

         from        MCD             mcd

             join    ORGANIZATION    org on (org.instit_code = mcd.instit_code and org.ORGANIZ_ID = TO_NUMBER(:organizationId))

-        where :c_with_op = 'T' /*for "with operator" only*/

+        where (select is_with_operator from is_with_operator where rownum =1) = 'T' /*for "with operator" only*/

             and not exists (select  1

                             from    P1S38                 ctd

                             where   mcd.CASHDESK_ID = ctd.CASHDESK_ID

@@ -3695,780 +3681,6 @@

               </RightBorder>

             </Style>

           </Tablix>

-          <Rectangle Name="Rectangle4">

-            <ReportItems>

-              <Textbox Name="Textbox89">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/OPERATOR", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>:</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>0mm</Top>

-                <Left>0.00043mm</Left>

-                <Height>6mm</Height>

-                <Width>33.3546mm</Width>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox90">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/OPENING_DATE", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>:</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>6mm</Top>

-                <Left>0.00043mm</Left>

-                <Height>6mm</Height>

-                <Width>33.3546mm</Width>

-                <ZIndex>1</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox92">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/ACCOUNTANT_REMARK", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>: </Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>=First(Fields!P1S1_R.Value, "main")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>18mm</Top>

-                <Left>0.00043mm</Left>

-                <Height>6mm</Height>

-                <Width>165.99917mm</Width>

-                <ZIndex>2</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox94">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/SALES_CHANNEL", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>:</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>0mm</Top>

-                <Left>76.74626mm</Left>

-                <Height>6mm</Height>

-                <Width>36.57027mm</Width>

-                <ZIndex>3</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox96">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/STATE", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>:</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>12mm</Top>

-                <Left>76.74583mm</Left>

-                <Height>6mm</Height>

-                <Width>36.57027mm</Width>

-                <ZIndex>4</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox110">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=First(Fields!P1S1_UN.Value, "main")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>0mm</Top>

-                <Left>33.35503mm</Left>

-                <Height>6mm</Height>

-                <Width>43.39123mm</Width>

-                <ZIndex>5</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox111">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Format(First(Fields!P1S1_ODT.Value, "main"), "dd/MM/yyyy HH:mm")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>6mm</Top>

-                <Left>33.35503mm</Left>

-                <Height>6mm</Height>

-                <Width>43.39123mm</Width>

-                <ZIndex>6</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox112">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=IIF(IsNothing(First(Fields!P1S1_CDT.Value, "main")), "-", Format(First(Fields!P1S1_CDT.Value, "main"), "dd/MM/yyyy HH:mm"))</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>12mm</Top>

-                <Left>33.35503mm</Left>

-                <Height>6mm</Height>

-                <Width>43.39123mm</Width>

-                <ZIndex>7</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox113">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=First(Fields!P1S1_SC.Value, "main")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>0mm</Top>

-                <Left>113.31653mm</Left>

-                <Height>6mm</Height>

-                <Width>52.68307mm</Width>

-                <ZIndex>8</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox114">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=First(Fields!P1S1_POS.Value, "main")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>6mm</Top>

-                <Left>113.3161mm</Left>

-                <Height>6mm</Height>

-                <Width>52.6835mm</Width>

-                <ZIndex>9</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox116">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=First(Fields!LABEL.Value, "currentCashDeskState")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>12mm</Top>

-                <Left>113.3161mm</Left>

-                <Height>6mm</Height>

-                <Width>52.6835mm</Width>

-                <ZIndex>10</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox95">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/POINT_OF_SALES", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>:</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>6mm</Top>

-                <Left>76.74626mm</Left>

-                <Height>6mm</Height>

-                <Width>36.57027mm</Width>

-                <ZIndex>11</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-              <Textbox Name="Textbox99">

-                <CanGrow>true</CanGrow>

-                <KeepTogether>true</KeepTogether>

-                <Paragraphs>

-                  <Paragraph>

-                    <TextRuns>

-                      <TextRun>

-                        <Value>=Lookup("SSRS_TR/CLOSE_DATE", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                      <TextRun>

-                        <Value>:</Value>

-                        <Style>

-                          <FontSize>9pt</FontSize>

-                          <FontWeight>Normal</FontWeight>

-                        </Style>

-                      </TextRun>

-                    </TextRuns>

-                    <Style>

-                      <TextAlign>Left</TextAlign>

-                    </Style>

-                  </Paragraph>

-                </Paragraphs>

-                <rd:DefaultName>Textbox89</rd:DefaultName>

-                <Top>12mm</Top>

-                <Left>0.00043mm</Left>

-                <Height>6mm</Height>

-                <Width>33.3546mm</Width>

-                <ZIndex>12</ZIndex>

-                <Style>

-                  <Border>

-                    <Color>LightGrey</Color>

-                    <Style>None</Style>

-                  </Border>

-                  <TopBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </TopBorder>

-                  <BottomBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </BottomBorder>

-                  <LeftBorder>

-                    <Color>LightGrey</Color>

-                    <Style>Solid</Style>

-                    <Width>1pt</Width>

-                  </LeftBorder>

-                  <RightBorder>

-                    <Color>LightGrey</Color>

-                  </RightBorder>

-                  <PaddingLeft>2pt</PaddingLeft>

-                  <PaddingRight>2pt</PaddingRight>

-                  <PaddingTop>2pt</PaddingTop>

-                  <PaddingBottom>2pt</PaddingBottom>

-                </Style>

-              </Textbox>

-            </ReportItems>

-            <KeepTogether>true</KeepTogether>

-            <Top>8mm</Top>

-            <Left>3.5987mm</Left>

-            <Height>24.30744mm</Height>

-            <Width>165.9996mm</Width>

-            <ZIndex>1</ZIndex>

-            <Style>

-              <Border>

-                <Style>None</Style>

-              </Border>

-            </Style>

-          </Rectangle>

           <Tablix Name="Tablix2">

             <TablixBody>

               <TablixColumns>

@@ -5343,7 +4555,7 @@

             <Left>3.59827mm</Left>

             <Height>22mm</Height>

             <Width>232.52234mm</Width>

-            <ZIndex>2</ZIndex>

+            <ZIndex>1</ZIndex>

             <Visibility>

               <Hidden>=IIF(IsNothing(Max(Fields!P1S2_DT.Value, "main")), true, false)</Hidden>

             </Visibility>

@@ -5353,63 +4565,6 @@

               </Border>

             </Style>

           </Tablix>

-          <Textbox Name="Textbox93">

-            <CanGrow>true</CanGrow>

-            <KeepTogether>true</KeepTogether>

-            <Paragraphs>

-              <Paragraph>

-                <TextRuns>

-                  <TextRun>

-                    <Value>=Lookup("SSRS_TR/CASH_DESK", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

-                    <Style>

-                      <FontSize>9pt</FontSize>

-                      <FontWeight>Bold</FontWeight>

-                      <Color>#474747</Color>

-                    </Style>

-                  </TextRun>

-                </TextRuns>

-                <Style>

-                  <TextAlign>Center</TextAlign>

-                </Style>

-              </Paragraph>

-            </Paragraphs>

-            <rd:DefaultName>Textbox89</rd:DefaultName>

-            <Top>0mm</Top>

-            <Left>3.59827mm</Left>

-            <Height>8mm</Height>

-            <Width>166.00003mm</Width>

-            <ZIndex>3</ZIndex>

-            <Style>

-              <Border>

-                <Color>LightGrey</Color>

-                <Style>Solid</Style>

-              </Border>

-              <TopBorder>

-                <Color>LightGrey</Color>

-                <Style>Solid</Style>

-                <Width>1pt</Width>

-              </TopBorder>

-              <BottomBorder>

-                <Style>None</Style>

-                <Width>1pt</Width>

-              </BottomBorder>

-              <LeftBorder>

-                <Color>LightGrey</Color>

-                <Style>Solid</Style>

-                <Width>1pt</Width>

-              </LeftBorder>

-              <RightBorder>

-                <Color>LightGrey</Color>

-                <Style>Solid</Style>

-                <Width>1pt</Width>

-              </RightBorder>

-              <VerticalAlign>Middle</VerticalAlign>

-              <PaddingLeft>2pt</PaddingLeft>

-              <PaddingRight>2pt</PaddingRight>

-              <PaddingTop>2pt</PaddingTop>

-              <PaddingBottom>2pt</PaddingBottom>

-            </Style>

-          </Textbox>

           <Textbox Name="Textbox104">

             <CanGrow>true</CanGrow>

             <KeepTogether>true</KeepTogether>

@@ -5434,7 +4589,7 @@

             <Left>3.59827mm</Left>

             <Height>6mm</Height>

             <Width>50.00003mm</Width>

-            <ZIndex>4</ZIndex>

+            <ZIndex>2</ZIndex>

             <Style>

               <Border>

                 <Style>None</Style>

@@ -5451,7 +4606,7 @@

             <Left>5.35983cm</Left>

             <Height>0.6cm</Height>

             <Width>7.5cm</Width>

-            <ZIndex>5</ZIndex>

+            <ZIndex>3</ZIndex>

             <Style>

               <Border>

                 <Color>LightGrey</Color>

@@ -5483,7 +4638,7 @@

             <Left>3.59827mm</Left>

             <Height>6mm</Height>

             <Width>50.00003mm</Width>

-            <ZIndex>6</ZIndex>

+            <ZIndex>4</ZIndex>

             <Style>

               <Border>

                 <Style>None</Style>

@@ -5500,7 +4655,7 @@

             <Left>5.35983cm</Left>

             <Height>0.6cm</Height>

             <Width>7.5cm</Width>

-            <ZIndex>7</ZIndex>

+            <ZIndex>5</ZIndex>

             <Style>

               <Border>

                 <Color>LightGrey</Color>

@@ -5532,7 +4687,7 @@

             <Left>3.59827mm</Left>

             <Height>6mm</Height>

             <Width>50.00003mm</Width>

-            <ZIndex>8</ZIndex>

+            <ZIndex>6</ZIndex>

             <Style>

               <Border>

                 <Style>None</Style>

@@ -5549,7 +4704,7 @@

             <Left>5.35983cm</Left>

             <Height>0.6cm</Height>

             <Width>7.5cm</Width>

-            <ZIndex>9</ZIndex>

+            <ZIndex>7</ZIndex>

             <Style>

               <Border>

                 <Color>LightGrey</Color>

@@ -6727,47 +5882,47 @@

                 <TablixMember />

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=Parameters!cashDeskMode.Value = "DIRECT" OR Parameters!c_with_op.Value = "F"</Hidden>

+                    <Hidden>=Parameters!cashDeskMode.Value = "DIRECT" OR Variables!c_with_op.Value = "F"</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=Parameters!cashDeskMode.Value = "DIRECT" OR Parameters!c_with_op.Value = "F"</Hidden>

+                    <Hidden>=Parameters!cashDeskMode.Value = "DIRECT" OR Variables!c_with_op.Value = "F"</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

                 <TablixMember>

                   <Visibility>

-                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Parameters!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Parameters!c_with_op.Value &lt;&gt; "F")</Hidden>

+                    <Hidden>=(Parameters!cashDeskMode.Value = "BLIND" AND Variables!currentCashDeskState.Value &lt;&gt; "FINANCIAL_CLOSURE" AND Variables!c_with_op.Value &lt;&gt; "F")</Hidden>

                   </Visibility>

                 </TablixMember>

               </TablixMembers>

@@ -6820,13 +5975,868 @@

             <Left>0.35983cm</Left>

             <Height>2.2cm</Height>

             <Width>26.6cm</Width>

-            <ZIndex>10</ZIndex>

+            <ZIndex>8</ZIndex>

             <Style>

               <Border>

                 <Style>None</Style>

               </Border>

             </Style>

           </Tablix>

+          <Rectangle Name="Rectangle4">

+            <ReportItems>

+              <Textbox Name="Textbox89">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/OPERATOR", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>:</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>0.35278mm</Top>

+                <Left>0.00043mm</Left>

+                <Height>6mm</Height>

+                <Width>33.3546mm</Width>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox90">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/OPENING_DATE", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>:</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>6.35278mm</Top>

+                <Left>0.00043mm</Left>

+                <Height>6mm</Height>

+                <Width>33.3546mm</Width>

+                <ZIndex>1</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox92">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/ACCOUNTANT_REMARK", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>: </Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>=First(Fields!P1S1_R.Value, "main")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>18.35278mm</Top>

+                <Left>0.00043mm</Left>

+                <Height>6mm</Height>

+                <Width>181.6971mm</Width>

+                <ZIndex>2</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox94">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/SALES_CHANNEL", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>:</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>0.35278mm</Top>

+                <Left>76.74626mm</Left>

+                <Height>6mm</Height>

+                <Width>36.57027mm</Width>

+                <ZIndex>3</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox96">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/STATE", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>:</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>12.35278mm</Top>

+                <Left>76.74583mm</Left>

+                <Height>6mm</Height>

+                <Width>36.57027mm</Width>

+                <ZIndex>4</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox110">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=First(Fields!P1S1_UN.Value, "main")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>0mm</Top>

+                <Left>33.35503mm</Left>

+                <Height>6mm</Height>

+                <Width>43.39123mm</Width>

+                <ZIndex>5</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox111">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Format(First(Fields!P1S1_ODT.Value, "main"), "dd/MM/yyyy HH:mm")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>6.35278mm</Top>

+                <Left>33.35503mm</Left>

+                <Height>6mm</Height>

+                <Width>43.39123mm</Width>

+                <ZIndex>6</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox112">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=IIF(IsNothing(First(Fields!P1S1_CDT.Value, "main")), "-", Format(First(Fields!P1S1_CDT.Value, "main"), "dd/MM/yyyy HH:mm"))</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>12.35278mm</Top>

+                <Left>33.35503mm</Left>

+                <Height>6mm</Height>

+                <Width>43.39123mm</Width>

+                <ZIndex>7</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox113">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=IIF(IsNothing(First(Fields!P1S1_SC.Value, "main")), "-", First(Fields!P1S1_SC.Value, "main"))</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>0.35278mm</Top>

+                <Left>113.31653mm</Left>

+                <Height>6mm</Height>

+                <Width>68.381mm</Width>

+                <ZIndex>8</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox114">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=IIF(IsNothing(First(Fields!P1S1_POS.Value, "main")), "-", First(Fields!P1S1_POS.Value, "main"))</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>6.35278mm</Top>

+                <Left>113.3161mm</Left>

+                <Height>6mm</Height>

+                <Width>68.38143mm</Width>

+                <ZIndex>9</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox116">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=First(Fields!LABEL.Value, "currentCashDeskState")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>12.35278mm</Top>

+                <Left>113.3161mm</Left>

+                <Height>6mm</Height>

+                <Width>68.38143mm</Width>

+                <ZIndex>10</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox95">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/POINT_OF_SALES", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>:</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>6.35278mm</Top>

+                <Left>76.74583mm</Left>

+                <Height>6mm</Height>

+                <Width>36.57027mm</Width>

+                <ZIndex>11</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+              <Textbox Name="Textbox99">

+                <CanGrow>true</CanGrow>

+                <KeepTogether>true</KeepTogether>

+                <Paragraphs>

+                  <Paragraph>

+                    <TextRuns>

+                      <TextRun>

+                        <Value>=Lookup("SSRS_TR/CLOSE_DATE", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                      <TextRun>

+                        <Value>:</Value>

+                        <Style>

+                          <FontSize>9pt</FontSize>

+                          <FontWeight>Normal</FontWeight>

+                        </Style>

+                      </TextRun>

+                    </TextRuns>

+                    <Style>

+                      <TextAlign>Left</TextAlign>

+                    </Style>

+                  </Paragraph>

+                </Paragraphs>

+                <rd:DefaultName>Textbox89</rd:DefaultName>

+                <Top>12.35278mm</Top>

+                <Left>0.00043mm</Left>

+                <Height>6mm</Height>

+                <Width>33.3546mm</Width>

+                <ZIndex>12</ZIndex>

+                <Style>

+                  <Border>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                  </Border>

+                  <TopBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </TopBorder>

+                  <BottomBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </BottomBorder>

+                  <LeftBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </LeftBorder>

+                  <RightBorder>

+                    <Color>LightGrey</Color>

+                    <Style>Solid</Style>

+                    <Width>1pt</Width>

+                  </RightBorder>

+                  <PaddingLeft>2pt</PaddingLeft>

+                  <PaddingRight>2pt</PaddingRight>

+                  <PaddingTop>2pt</PaddingTop>

+                  <PaddingBottom>2pt</PaddingBottom>

+                </Style>

+              </Textbox>

+            </ReportItems>

+            <KeepTogether>true</KeepTogether>

+            <Top>7.86543mm</Top>

+            <Left>4.42308mm</Left>

+            <Height>24.66022mm</Height>

+            <Width>181.69753mm</Width>

+            <ZIndex>9</ZIndex>

+            <Style>

+              <Border>

+                <Style>None</Style>

+              </Border>

+            </Style>

+          </Rectangle>

+          <Textbox Name="Textbox93">

+            <CanGrow>true</CanGrow>

+            <KeepTogether>true</KeepTogether>

+            <Paragraphs>

+              <Paragraph>

+                <TextRuns>

+                  <TextRun>

+                    <Value>=Lookup("SSRS_TR/CASH_DESK", Fields!CODE.Value, Fields!VALUE.Value, "labels")</Value>

+                    <Style>

+                      <FontSize>9pt</FontSize>

+                      <FontWeight>Bold</FontWeight>

+                      <Color>#474747</Color>

+                    </Style>

+                  </TextRun>

+                </TextRuns>

+                <Style>

+                  <TextAlign>Center</TextAlign>

+                </Style>

+              </Paragraph>

+            </Paragraphs>

+            <rd:DefaultName>Textbox89</rd:DefaultName>

+            <Top>0.21821mm</Top>

+            <Left>4.42265mm</Left>

+            <Height>8mm</Height>

+            <Width>181.69796mm</Width>

+            <ZIndex>10</ZIndex>

+            <Style>

+              <Border>

+                <Color>LightGrey</Color>

+                <Style>Solid</Style>

+              </Border>

+              <TopBorder>

+                <Color>LightGrey</Color>

+                <Style>Solid</Style>

+                <Width>1pt</Width>

+              </TopBorder>

+              <BottomBorder>

+                <Style>None</Style>

+                <Width>1pt</Width>

+              </BottomBorder>

+              <LeftBorder>

+                <Color>LightGrey</Color>

+                <Style>Solid</Style>

+                <Width>1pt</Width>

+              </LeftBorder>

+              <RightBorder>

+                <Color>LightGrey</Color>

+                <Style>Solid</Style>

+                <Width>1pt</Width>

+              </RightBorder>

+              <VerticalAlign>Middle</VerticalAlign>

+              <PaddingLeft>2pt</PaddingLeft>

+              <PaddingRight>2pt</PaddingRight>

+              <PaddingTop>2pt</PaddingTop>

+              <PaddingBottom>2pt</PaddingBottom>

+            </Style>

+          </Textbox>

         </ReportItems>

         <Height>197.84385mm</Height>

         <Style>

@@ -6836,7 +6846,7 @@

           <BackgroundColor>White</BackgroundColor>

         </Style>

       </Body>

-      <Width>278.5983mm</Width>

+      <Width>289.14532mm</Width>

       <Page>

         <PageHeader>

           <Height>2.9898cm</Height>

@@ -7146,33 +7156,25 @@

       </ValidValues>

       <UsedInQuery>False</UsedInQuery>

     </ReportParameter>

-    <ReportParameter Name="currentOperatorId">

+    <ReportParameter Name="currentUser">

       <DataType>String</DataType>

       <DefaultValue>

-        <DataSetReference>

-          <DataSetName>currentOperator</DataSetName>

-          <ValueField>OPERATOR_ID</ValueField>

-        </DataSetReference>

+        <Values>

+          <Value>-1</Value>

+        </Values>

       </DefaultValue>

-      <Prompt>currentOperatorId</Prompt>

+      <Prompt>currentUser</Prompt>

       <Hidden>true</Hidden>

-      <ValidValues>

-        <DataSetReference>

-          <DataSetName>currentOperator</DataSetName>

-          <ValueField>OPERATOR_ID</ValueField>

-          <LabelField>OPERATOR_ID</LabelField>

-        </DataSetReference>

-      </ValidValues>

     </ReportParameter>

     <ReportParameter Name="openDate">

       <DataType>DateTime</DataType>

       <Nullable>true</Nullable>

-      <Prompt>ORIGIN::OPENING_DATE</Prompt>

+      <Prompt>GENERAL::OPENING_DATE</Prompt>

     </ReportParameter>

     <ReportParameter Name="closingDate">

       <DataType>DateTime</DataType>

       <Nullable>true</Nullable>

-      <Prompt>ORIGIN::CLOSE_DATE</Prompt>

+      <Prompt>GENERAL::CLOSE_DATE</Prompt>

     </ReportParameter>

     <ReportParameter Name="cashDeskState">

       <DataType>String</DataType>

@@ -7181,7 +7183,7 @@

           <Value>=Parameters!allId.Value</Value>

         </Values>

       </DefaultValue>

-      <Prompt>ORIGIN::CASHDESK_STATE</Prompt>

+      <Prompt>GENERAL::CASHDESK_STATE</Prompt>

       <ValidValues>

         <DataSetReference>

           <DataSetName>cashdeskState</DataSetName>

@@ -7197,7 +7199,7 @@

           <Value>=Parameters!noneId.Value</Value>

         </Values>

       </DefaultValue>

-      <Prompt>ORIGIN::SALES_CHANNEL</Prompt>

+      <Prompt>GENERAL::SALES_CHANNEL</Prompt>

       <ValidValues>

         <DataSetReference>

           <DataSetName>salesChannels</DataSetName>

@@ -7214,7 +7216,7 @@

           <Value>=Parameters!noneId.Value</Value>

         </Values>

       </DefaultValue>

-      <Prompt>ORIGIN::OPERATOR</Prompt>

+      <Prompt>CASH_DESK_W_OPERATOR::OPERATOR</Prompt>

       <ValidValues>

         <DataSetReference>

           <DataSetName>operators</DataSetName>

@@ -7230,7 +7232,7 @@

           <Value>=Parameters!noneId.Value</Value>

         </Values>

       </DefaultValue>

-      <Prompt>ORIGIN::INTERNET_POS</Prompt>

+      <Prompt>CASH_DESK_WO_OPERATOR::INTERNET_POS</Prompt>

       <ValidValues>

         <DataSetReference>

           <DataSetName>pointOfSales</DataSetName>

@@ -7241,13 +7243,7 @@

     </ReportParameter>

     <ReportParameter Name="cashDeskId">

       <DataType>String</DataType>

-      <DefaultValue>

-        <DataSetReference>

-          <DataSetName>cashDesks</DataSetName>

-          <ValueField>CASHDESK_ID</ValueField>

-        </DataSetReference>

-      </DefaultValue>

-      <Prompt>ORIGIN::CASH_DESK</Prompt>

+      <Prompt>CASH_DESK::CASH_DESK</Prompt>

       <ValidValues>

         <DataSetReference>

           <DataSetName>cashDesks</DataSetName>

@@ -7256,24 +7252,17 @@

         </DataSetReference>

       </ValidValues>

     </ReportParameter>

-    <ReportParameter Name="currentCashDeskState">

-      <DataType>String</DataType>

-      <DefaultValue>

-        <DataSetReference>

-          <DataSetName>currentCashDeskState</DataSetName>

-          <ValueField>STATE</ValueField>

-        </DataSetReference>

-      </DefaultValue>

-      <Hidden>true</Hidden>

-    </ReportParameter>

     <ReportParameter Name="cashDeskMode">

       <DataType>String</DataType>

+      <Nullable>true</Nullable>

       <DefaultValue>

         <DataSetReference>

           <DataSetName>organization_logo</DataSetName>

           <ValueField>CASH_DESK_MANAGEMENT_MODE</ValueField>

         </DataSetReference>

       </DefaultValue>

+      <AllowBlank>true</AllowBlank>

+      <Prompt>CASH_DESK::cashDeskMode</Prompt>

       <Hidden>true</Hidden>

     </ReportParameter>

     <ReportParameter Name="c_check">

@@ -7285,23 +7274,6 @@

       </DefaultValue>

       <Hidden>true</Hidden>

     </ReportParameter>

-    <ReportParameter Name="c_with_op">

-      <DataType>String</DataType>

-      <DefaultValue>

-        <DataSetReference>

-          <DataSetName>is_with_operator</DataSetName>

-          <ValueField>IS_WITH_OPERATOR</ValueField>

-        </DataSetReference>

-      </DefaultValue>

-      <Hidden>true</Hidden>

-      <ValidValues>

-        <DataSetReference>

-          <DataSetName>is_with_operator</DataSetName>

-          <ValueField>IS_WITH_OPERATOR</ValueField>

-          <LabelField>IS_WITH_OPERATOR</LabelField>

-        </DataSetReference>

-      </ValidValues>

-    </ReportParameter>

     <ReportParameter Name="c_inter_wd_id">

       <DataType>String</DataType>

       <DefaultValue>

@@ -7451,6 +7423,19 @@

 End Function



  </Code>

+  <Variables>

+    <Variable Name="currentCashDeskState">

+      <Value>=Max(Fields!STATE.Value, "currentCashDeskState")</Value>

+      <Writable>true</Writable>

+    </Variable>

+    <Variable Name="c_with_op">

+      <Value>=Max(Fields!IS_WITH_OPERATOR.Value, "is_with_operator")</Value>

+      <Writable>true</Writable>

+    </Variable>

+    <Variable Name="current_user">

+      <Value>=IIF(Instr(User!UserID, "#") &gt; 0,Split(User!UserID,"#").GetValue(1),User!UserID)</Value>

+    </Variable>

+  </Variables>

   <rd:ReportUnitType>Cm</rd:ReportUnitType>

   <rd:ReportServerUrl>http://int1ssrs1a.hrp.secutix.net/reportserver</rd:ReportServerUrl>

   <rd:ReportID>a4734754-3bad-49f5-a2b9-cd05b4484a07</rd:ReportID>


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Monday, May 09, 2016 19:28
To:	prj_Secutix2Co
Subject:	secutix2-co: svn commit (trg) [12853] STX-65479:  Fix display wrong volume contacts when import contacts for existing target by csv file.

Categories:	@TAA, SAM & Contact, @DLP

Revision
12853 <https://svn.elca.ch/viewvc/secutix2-co?rev=12853>
Author
trg
Date
2016-05-09 14:27:59 +0200 (Mon, 09 May 2016)


Log Message

STX-65479 <https://jira.secutix.com/browse/STX-65479> : Fix display wrong volume contacts when import contacts for existing target by csv file. Fix regression from Jira STX-63646 <https://jira.secutix.com/browse/STX-63646> .

Modified Paths


*	trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/editCampaignTargetByCSVFileImporting.jsp <>
*	trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/importContactsByCsvFile.jsp <>


Diff


Modified: trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/editCampaignTargetByCSVFileImporting.jsp (12852 => 12853)



--- trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/editCampaignTargetByCSVFileImporting.jsp	2016-05-09 12:15:06 UTC (rev 12852)

+++ trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/editCampaignTargetByCSVFileImporting.jsp	2016-05-09 12:27:59 UTC (rev 12853)

@@ -28,7 +28,7 @@

     <jsp:attribute name="center">

         <script charset="UTF-8" type="text/javascript" src="${baseURL}stx2co/stx_tncoHelper.js"></script>

         <script type="text/javascript">

-            var showImportPopup, callback, reloadListContactHandler, getContactsFn, displayMessageWhileSaving, addContact, showSelectContactPopup, showMaskFunc, workerExecutable, updateContactList, terminateWorkerWhenUnload;

+            var showImportPopup, callback, reloadListContactHandler, getContactsFn, displayMessageWhileSaving, addContact, showSelectContactPopup, showMaskFunc, hideMaskFunc, workerExecutable, updateContactList, terminateWorkerWhenUnload;

             getContactsFn = function(contactIds, entid, removeExistingContact, callback) {

                 if(contactIds || contactIds && entid){

                     var newUrl;

@@ -102,7 +102,7 @@

                         updateContactList(data, form, imported);

                         removeUnloadHandler();

                         clearTimeout(displayMsgForHeavyProcess);

-                        stx_mask.hide(window.document);

+                        hideMaskFunc();

                     };

                     terminateWorkerWhenUnload = function() {

                         worker.terminate();

@@ -119,7 +119,7 @@

                         stx_displayMsg(stx_${entityName}_detail.getId(), '<sp:message code="label.page.jsErrorMsg" javaScriptEscape="true" />' ,'error');

                         removeUnloadHandler();

                         clearTimeout(displayMsgForHeavyProcess);

-                        stx_mask.hide(window.document);

+                        hideMaskFunc();

                     };

                     displayMsgForHeavyProcess = setTimeout(function(){

                         stx_displayMsg(stx_${entityName}_detail.getId(), '<sp:message code="message.CampaignTarget.updateInProgress.waiting" javaScriptEscape="true" />', 'warning');

@@ -130,27 +130,25 @@

                 }

             };

             updateContactList = function (data, form, imported){

-                var dummyVolume,

-                    realVolume,

-                    contactIds,

+                var contactIds,

                     removeExisting,

                     volume,

-                    removeValue;

-                form.findField("contactIds").setValue(imported);

+                    removeValue,

+                    realContactIds;

+                realContactIds = form.findField("contactIds");

+                realContactIds.setValue(imported);

                 // because the _targetVolume is disable, the system will generate the real input with name __targetVolume

                 // and hide input one with name _targetVolume

-                dummyVolume = form.findField('__targetVolume');

-                realVolume = form.findField('targetVolume');

+                volume = form.findField('__targetVolume');

+                imported.length > 0 ? volume.setValue(imported.length) : volume;

                 removeExisting = form.findField("removeExisting");

                 removeValue = removeExisting.getValue() === "true" || data.removeExistingContact;

                 removeExisting.setValue(removeValue);

-                volume = (removeValue || Ext.isEmpty(stx_${entityName}_detail.getEntId())) ? imported.length : parseInt(realVolume.getValue()) + imported.length;

-                dummyVolume.setValue(volume);

                 if(imported.length > 0) {

                     contactIds = imported.length <= ${maxResult} ? imported : imported.slice(0, ${maxResult});

                     getContactsFn(contactIds, stx_${entityName}_detail.getEntId(), removeValue,showMaskFunc);

                 } else {

-                    stx_mask.hide(window.document);

+                    hideMaskFunc();

                 }

             };



@@ -158,6 +156,9 @@

             	stx_mask.show(window.document,false,true);

             };



+            hideMaskFunc = function() {

+                stx_mask.hide(window.document);

+            };

             showImportPopup = function () {

                 var url, popup, form, removeExisting;

                 form = stx_${entityName}_detail.getForm();



Modified: trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/importContactsByCsvFile.jsp (12852 => 12853)



--- trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/importContactsByCsvFile.jsp	2016-05-09 12:15:06 UTC (rev 12852)

+++ trunk/app/tnco/web/war/src/main/webapp/WEB-INF/jsps/importContactsByCsvFile.jsp	2016-05-09 12:27:59 UTC (rev 12853)

@@ -18,7 +18,7 @@

     <jsp:attribute name="center">

        	<script type="text/javascript">



-	        var stx_callbacks, stx_registerCallback, submit;

+	        var stx_callbacks, stx_registerCallback, submit, closeFunc, isOpenMask;



 	        stx_callbacks = {};

 			stx_registerCallback = function(event, callback, scope) {

@@ -47,7 +47,8 @@



                     // show mask without Spinner for user selection when import wrong csv format.

                     if(result.imported.length == 0){

-                    	opener.stx_mask.show.call(opener.stx_mask, opener.document,false,true);

+                        opener.stx_mask.show.call(opener.stx_mask, opener.document,false,true);

+                        isOpenMask = true;

                     }

 	            	setValue(Ext.get('imported_number'), parseInt(result.importedQty) + duplicatedQuantity);

 	            	setValue(Ext.get('non_imported_number'), parseInt(result.unimportedQty));

@@ -108,7 +109,13 @@

 	                        }

 	                    )

 	            );

-       		}

+       	    };

+       	    closeFunc = function (){

+                if(isOpenMask === true){

+                   stx_mask.hide(opener.document);

+                }

+                window.self.close();

+       	    };

    		</script>

         <div id="importedResult" class="stx_displayNone">

             <div tabindex="-1" class="x-form-item" id="imported_area">

@@ -143,7 +150,7 @@

 	            });

         </jsp:body>

         </widget:stx_details>

-        <widget:stx_button id="${entityName}Create_cancel" onClick="window.self.close()">

+        <widget:stx_button id="${entityName}Create_cancel" onClick="closeFunc();">

             <jsp:attribute name="label"><sp:message code="label.cancel" javaScriptEscape="true" /></jsp:attribute>

         </widget:stx_button>

         <widget:stx_button id="${entityName}Create_ok" onClick="submit(); return;" level="1">


ELCA Subversion service
From:	noreply@elca.ch
Sent:	Monday, May 09, 2016 09:39
To:	prj_Secutix2Bi
Subject:	secutix2-bi: svn commit (thu) [8719] STX-65808:  Cannot run INIT_TICKETS_ENTITIES

Categories:	Report, @THP, @QHR

Revision
8719 <https://svn.elca.ch/viewvc/secutix2-bi?rev=8719>
Author
thu
Date
2016-05-09 04:38:42 +0200 (Mon, 09 May 2016)


Log Message

STX-65808 <https://jira.secutix.com/browse/STX-65808> : Cannot run INIT_TICKETS_ENTITIES

Modified Paths


*	branches/dufour_v3/app/tnbi/model/src/main/resources/etc/sql/recurring_scripts/bil_report/02_report_domain_handler.pkb <>


Diff


Modified: branches/dufour_v3/app/tnbi/model/src/main/resources/etc/sql/recurring_scripts/bil_report/02_report_domain_handler.pkb (8718 => 8719)



--- branches/dufour_v3/app/tnbi/model/src/main/resources/etc/sql/recurring_scripts/bil_report/02_report_domain_handler.pkb	2016-05-06 08:03:41 UTC (rev 8718)

+++ branches/dufour_v3/app/tnbi/model/src/main/resources/etc/sql/recurring_scripts/bil_report/02_report_domain_handler.pkb	2016-05-09 02:38:42 UTC (rev 8719)

@@ -2554,7 +2554,6 @@

       AVG(sales.unit_amt_itx) as avg_unit_amt_itx,

       -- attendance

       count(distinct mvt.movement_id) as nb_of_sales,

-      SUM(tc.nb_control_ok) as nb_of_entrances,

       --SUM(tc.nb_control_ok) as nb_of_entrances,

 	  count(distinct (case when tc.nb_control_ok > 0 then tc.ticket_id else null end)) as nb_of_entrances,

 	  -- a not controlled ticket should not have any ticket check linked to it, so the following line will count only 1 for each ticket


ELCA Subversion service
